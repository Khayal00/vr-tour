<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Tour with Gaze Color Change</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
      #welcomeScreen {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: linear-gradient(135deg,#1a1a1a,#000000);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        color:white; z-index:9999;
      }
      #welcomeScreen h1 { font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 8px rgba(255,255,255,0.6); }
      #instructions { font-size: 1em; margin-bottom: 30px; opacity: 0.85; }
      .progress-container { width: 60%; background: rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; height: 20px; margin-bottom: 25px; }
      .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe, #00f2fe); transition: width 0.3s; }
      #startBtn { padding: 12px 28px; border: none; border-radius: 30px; background: #4facfe; color: white; font-size: 1.1em; cursor: pointer; display:none; }
      #startBtn:hover { background: #00f2fe; }
    </style>
  </head>
  <body>
    <div id="welcomeScreen">
      <h1>✨ VR Tour ✨</h1>
      <div id="instructions">استخدم الماوس/النظر أو وحدات التحكم للتنقّل</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <button id="startBtn">ابدأ الجولة</button>
    </div>

    <a-scene renderer="colorManagement: true; antialias: true">
      <!-- الكاميرا + المؤشر -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-entity camera look-controls>
          <a-entity id="cursorContainer" position="0 0 -1">
            <a-cursor id="cursor"
                      fuse="true" fuse-timeout="800"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat; opacity: 0.9; side: double; depthTest: false"
                      raycaster="objects: .hotspot">
              <a-animation attribute="scale"
                           from="1 1 1" to="1.3 1.3 1.3"
                           dur="1000"
                           direction="alternate"
                           repeat="indefinite"
                           easing="easeInOutSine"></a-animation>
            </a-cursor>

            <a-ring radius-inner="0.035" radius-outer="0.06"
                    material="color: #00f2fe; shader: flat; opacity: 0.4; side: double"
                    animation="property: scale; from: 1 1 1; to: 1.4 1.4 1.4; dur: 1200; easing: easeInOutSine; dir: alternate; loop: true">
            </a-ring>
          </a-entity>
        </a-entity>

        <a-entity laser-controls="hand: right" raycaster="objects: .hotspot"></a-entity>
        <a-entity laser-controls="hand: left"  raycaster="objects: .hotspot"></a-entity>
      </a-entity>

      <a-sky id="skyFront" rotation="0 -90 0" src="#imgLiving" material="shader: flat; transparent: true; opacity: 1"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0" material="shader: flat; transparent: true; opacity: 0"></a-sky>
      <a-entity id="hotspotContainer"></a-entity>

      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3"></audio>
        <img id="imgLiving"   src="assets/Living_Room.jpg">
        <img id="imgKitchen"  src="assets/Kitchen.jpg">
        <img id="imgReception"src="assets/Reception.jpg">
        <img id="imgCorridor" src="assets/Corridor.jpg">
        <img id="imgBathroom" src="assets/Bathroom.jpg">
        <img id="imgBedroom"  src="assets/Bedroom.jpg">
      </a-assets>
    </a-scene>

    <script>
      const scenes = {
        Living_Room: {
          src: '#imgLiving',
          hotspots: [
            { target: 'Kitchen',    position: '-3 1.6 4',    img: 'assets/link2.png', size: 0.6 },
            { target: 'Reception',  position: '-3 1.6 -1.7', img: 'assets/link.png',  size: 0.6 },
            { target: 'Corridor',   position: '3 1.6 3',     img: 'assets/link1.png', size: 0.6 }
          ]
        },
        Kitchen:    { src: '#imgKitchen',   hotspots: [ { target: 'Living_Room', position: '4 1.6 -7',  img: 'assets/link2.png', size: 0.8 } ] },
        Reception:  { src: '#imgReception', hotspots: [ { target: 'Living_Room', position: '5 1.6 -1',   img: 'assets/link.png',  size: 0.6 } ] },
        Corridor:   {
          src: '#imgCorridor',
          hotspots: [
            { target: 'Bathroom',    position: '3 1.6 -0.5',   img: 'assets/link2.png', size: 0.6 },
            { target: 'Bedroom',     position: '-0.2 1.6 -3.5',img: 'assets/link2.png', size: 0.6 },
            { target: 'Living_Room', position: '1 1.6 3',      img: 'assets/link2.png', size: 0.6 }
          ]
        },
        Bathroom:   { src: '#imgBathroom',  hotspots: [ { target: 'Corridor', position: '-1 1.6 4',  img: 'assets/link1.png', size: 0.6 } ] },
        Bedroom:    { src: '#imgBedroom',   hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.6 } ] }
      };

      function makeGlowDataURL(size = 512, colorCenter = '255,240,200', colorMid = '0,128,255') {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
        grad.addColorStop(0, `rgba(${colorCenter}, 0.95)`);
        grad.addColorStop(0.25, `rgba(${colorMid}, 0.7)`);
        grad.addColorStop(0.5, `rgba(${colorMid}, 0.4)`);
        grad.addColorStop(1, `rgba(${colorMid}, 0)`);
        ctx.fillStyle = grad; ctx.fillRect(0,0,size,size);
        return canvas.toDataURL();
      }

      function createHotspots(sceneName) {
        const hotspotContainer = document.querySelector('#hotspotContainer');
        hotspotContainer.innerHTML = '';
        const scene = scenes[sceneName] || { hotspots: [] };

        scene.hotspots.forEach((hs, idx) => {
          const glowId = `glow-img-${sceneName}-${idx}-${Date.now()}`;
          const dataURL = makeGlowDataURL(512);
          const glowImg = document.createElement('img');
          glowImg.setAttribute('id', glowId);
          glowImg.setAttribute('src', dataURL);
          document.querySelector('a-assets').appendChild(glowImg);

          const el = document.createElement('a-plane');
          el.setAttribute('class', 'hotspot');
          el.setAttribute('position', hs.position);
          el.setAttribute('width', hs.size || 0.6);
          el.setAttribute('height', hs.size || 0.6);
          el.setAttribute('material', `src: url(${hs.img}); transparent: true; shader: flat; opacity: 1`);
          el.setAttribute('look-at', '#cameraRig');
          el.setAttribute('scale', '0 0 0');
          el.setAttribute('animation__popin', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');
          el.addEventListener('animationcomplete__popin', () => {
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
          });

          const glow = document.createElement('a-plane');
          glow.setAttribute('position', hs.position);
          const glowScale = (hs.size || 0.6) * 1.2;
          glow.setAttribute('width', glowScale);
          glow.setAttribute('height', glowScale);
          glow.setAttribute('look-at', '#cameraRig');
          glow.setAttribute('material', `src: #${glowId}; transparent: true; shader: flat; depthTest: false; opacity: 0`);
          glow.setAttribute('visible', 'false');

          const label = document.createElement('a-text');
          label.setAttribute('value', hs.target.replace('_', ' '));
          label.setAttribute('align', 'center');
          label.setAttribute('color', '#FFFFFF');
          label.setAttribute('width', 4);
          label.setAttribute('look-at', '#cameraRig');
          const pos = hs.position.split(' ');
          label.setAttribute('position', `${pos[0]} ${parseFloat(pos[1]) + 0.6} ${pos[2]}`);
          label.setAttribute('scale', '0 0 0');
          label.setAttribute('visible', 'true');

          // تغيير لون المؤشر عند المرور على الهوت سبوت
          el.addEventListener('mouseenter', () => {
            const cursor = document.querySelector('#cursor');
            cursor.setAttribute('material', 'color: #00f2fe'); // أزرق
            el.removeAttribute('animation__pulse');
            el.setAttribute('animation__hover', 'property: scale; to: 1.5 1.5 1.5; dur: 180; easing: easeOutQuad');
            label.removeAttribute('animation__scalefadeout');
            label.setAttribute('animation__scalefadein', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            glow.setAttribute('visible', 'true');
            glow.removeAttribute('animation__fadeout');
            glow.setAttribute('animation__fadein', 'property: material.opacity; to: 0.85; dur: 200; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscaleback');
            glow.setAttribute('animation__glowscale', 'property: scale; to: 1.25 1.25 1.25; dur: 200; easing: easeOutQuad');
          });

          el.addEventListener('mouseleave', () => {
            const cursor = document.querySelector('#cursor');
            cursor.setAttribute('material', 'color: white'); // أبيض
            el.removeAttribute('animation__hover');
            el.setAttribute('scale', '1 1 1');
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
            label.removeAttribute('animation__scalefadein');
            label.setAttribute('animation__scalefadeout', 'property: scale; to: 0 0 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__fadein');
            glow.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscale');
            glow.setAttribute('animation__glowscaleback', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            setTimeout(() => { try { glow.setAttribute('visible', 'false'); } catch(e){} }, 320);
          });

          el.addEventListener('click', () => { changeScene(hs.target); });

          const container = document.querySelector('#hotspotContainer');
          container.appendChild(glow);
          container.appendChild(el);
          container.appendChild(label);
        });
      }

      function changeScene(sceneName, duration = 700) {
        const next = scenes[sceneName];
        if (!next) return;

        const skyFront = document.querySelector('#skyFront');
        const skyBack  = document.querySelector('#skyBack');
        const hotspotContainer = document.querySelector('#hotspotContainer');
        const audio = document.querySelector('#transitionSound');

        hotspotContainer.innerHTML = '';
        skyBack.setAttribute('src', next.src);
        skyBack.setAttribute('material', 'shader: flat; transparent: true; opacity: 0');

        try { audio.pause(); audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){}

        ['animation__fadein','animation__fadeout'].forEach(a => { skyBack.removeAttribute(a); skyFront.removeAttribute(a); });

        skyBack.setAttribute('animation__fadein', {
          property: 'material.opacity', from: 0, to: 1, dur: duration, easing: 'easeInOutQuad'
        });
        skyFront.setAttribute('animation__fadeout', {
          property: 'material.opacity', from: 1, to: 0, dur: duration, easing: 'easeInOutQuad'
        });

        setTimeout(() => {
          skyFront.setAttribute('src', next.src);
          skyFront.setAttribute('material', 'shader: flat; transparent: true; opacity: 1');
          skyBack.setAttribute('material', 'shader: flat; transparent: true; opacity: 0');
          createHotspots(sceneName);
        }, duration);
      }

      const assets = document.querySelector('a-assets');
      const progressBar = document.getElementById('progressBar');
      const startBtn = document.getElementById('startBtn');
      const welcomeScreen = document.getElementById('welcomeScreen');

      assets.addEventListener('progress', (e) => {
        const loaded = e.detail && e.detail.loadedBytes ? e.detail.loadedBytes : 0;
        const total  = e.detail && e.detail.totalBytes  ? e.detail.totalBytes  : 0;
        const percent = total > 0 ? Math.floor((loaded/total)*100) : 0;
        progressBar.style.width = percent + '%';
      });

      assets.addEventListener('loaded', () => {
        progressBar.style.width = '100%';
        startBtn.style.display = 'block';
      });

      startBtn.addEventListener('click', () => {
        welcomeScreen.style.transition = 'opacity 0.7s';
        welcomeScreen.style.opacity = '0';
        setTimeout(() => { welcomeScreen.style.display = 'none'; }, 700);
        createHotspots('Living_Room');
      });
    </script>
  </body>
</html>
