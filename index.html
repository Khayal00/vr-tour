<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جولة افتراضية متكاملة</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe-master.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: #000;
        }
        #scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        .logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }
        #progress-container {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4361ee, #4cc9f0);
            transition: width 0.3s;
        }
        #scene-title {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            z-index: 10;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
        }
        .instructions {
            margin-top: 20px;
            text-align: center;
            max-width: 500px;
            line-height: 1.6;
            color: #b8c1ec;
        }
        #error-message {
            color: #ff6b6b;
            margin-top: 20px;
            text-align: center;
            max-width: 500px;
            display: none;
        }
        #retry-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="logo">الجولة الافتراضية</div>
        <div id="status">جاري تحميل المشهد...</div>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div class="instructions">
            يمكنك استخدام الماوس للتحريك في جميع الاتجاهات.<br>
            انقر على النقاط البيضاء للانتقال بين الغرف.
        </div>
        <div id="error-message"></div>
        <button id="retry-button">إعادة المحاولة</button>
    </div>
    
    <div id="scene-container">
        <a-scene>
            <!-- الكاميرا -->
            <a-entity id="camera" camera="fov: 80" look-controls="pointerLockEnabled: true" position="0 1.6 0">
                <a-cursor
                    rayOrigin="mouse"
                    fuse="false"
                    material="color: white; shader: flat"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03">
                </a-cursor>
            </a-entity>

            <!-- السماء -->
            <a-sky id="sky"></a-sky>

            <!-- حاوية نقاط الانتقال -->
            <a-entity id="hotspotContainer"></a-entity>
        </a-scene>
        <div id="scene-title">غرفة المعيشة</div>
    </div>

    <script>
        // ============================================
        // === روابط الصور الافتراضية (يمكن استبدالها) ===
        // ============================================
        
        // روابط صور المشاهد
        const sceneImages = {
            livingRoom: 'assets/Living_Room.jpg',
            kitchen: 'assets/Reception.jpg',
            bedroom: 'https://cdn.aframe.io/360-image-gallery-boilerplate/img/bedroom.jpg'
        };

        // روابط صور نقاط الانتقال
        const hotspotImages = {
            normal: 'assets/Kitchen1.png',
            hover: 'assets/Reception1.png'
        };

        // رابط صوت الانتقال
        const audioFile = 'https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.ogg';

        // ============================================
        // === تعريف المشاهد ونقاط الانتقال ===
        // ============================================
        
        // تعريف المشاهد
        const scenes = {
            livingRoom: {
                name: "غرفة المعيشة",
                image: sceneImages.livingRoom,
                hotspots: [
                    { target: "kitchen", position: "-1 1.6 -3", label: "المطبخ" },
                    { target: "bedroom", position: "1 1.6 -3", label: "غرفة النوم" }
                ]
            },
            kitchen: {
                name: "المطبخ",
                image: sceneImages.kitchen,
                hotspots: [
                    { target: "livingRoom", position: "0 1.6 -4", label: "غرفة المعيشة" }
                ]
            },
            bedroom: {
                name: "غرفة النوم",
                image: sceneImages.bedroom,
                hotspots: [
                    { target: "livingRoom", position: "0 1.6 -4", label: "غرفة المعيشة" }
                ]
            }
        };

        // ============================================
        // === نظام التحميل المتطور ===
        // ============================================
        
        // متغيرات التطبيق
        let assetsLoaded = false;
        let audioElement;
        let hotspotImageNormal;
        let hotspotImageHover;
        let totalAssets;
        let loadedCount = 0;
        let assetsErrors = [];
        
        // عناصر واجهة المستخدم
        const loadingElement = document.getElementById('loading');
        const progressBar = document.getElementById('progress-bar');
        const statusElement = document.getElementById('status');
        const errorMessage = document.getElementById('error-message');
        const retryButton = document.getElementById('retry-button');
        
        // تحميل جميع الأصول
        function loadAssets() {
            statusElement.textContent = "جاري تحميل المشهد...";
            errorMessage.style.display = "none";
            retryButton.style.display = "none";
            progressBar.style.width = "0%";
            
            totalAssets = Object.keys(sceneImages).length + 3; // 3 للصور الإضافية
            loadedCount = 0;
            assetsErrors = [];
            
            // تحديث شريط التقدم
            updateProgress();
            
            // تحميل الصوت
            audioElement = new Audio(audioFile);
            audioElement.preload = 'auto';
            audioElement.addEventListener('canplaythrough', assetLoaded);
            audioElement.addEventListener('error', () => handleError('صوت الانتقال', audioFile));
            
            // تحميل صور النقاط
            hotspotImageNormal = new Image();
            hotspotImageNormal.src = hotspotImages.normal;
            hotspotImageNormal.addEventListener('load', assetLoaded);
            hotspotImageNormal.addEventListener('error', () => handleError('صورة النقطة العادية', hotspotImages.normal));
            
            hotspotImageHover = new Image();
            hotspotImageHover.src = hotspotImages.hover;
            hotspotImageHover.addEventListener('load', assetLoaded);
            hotspotImageHover.addEventListener('error', () => handleError('صورة النقطة عند المرور', hotspotImages.hover));
            
            // تحميل صور المشاهد
            Object.keys(sceneImages).forEach(sceneId => {
                const img = new Image();
                img.src = sceneImages[sceneId];
                img.addEventListener('load', assetLoaded);
                img.addEventListener('error', () => handleError(`مشهد ${sceneId}`, sceneImages[sceneId]));
            });
            
            // بدء مهلة زمنية للتحميل
            startLoadTimeout();
        }
        
        // دالة تحديث شريط التقدم
        function updateProgress() {
            const progress = Math.round((loadedCount / totalAssets) * 100);
            progressBar.style.width = `${progress}%`;
            statusElement.textContent = `جاري التحميل: ${progress}%`;
        }
        
        // دالة معالجة الأخطاء
        function handleError(assetName, assetUrl) {
            assetsErrors.push({name: assetName, url: assetUrl});
            loadedCount++;
            updateProgress();
            
            // إذا اكتمل التحميل (بأخطاء)
            if (loadedCount >= totalAssets) {
                finishLoadingWithErrors();
            }
        }
        
        // دالة عند تحميل أصل بنجاح
        function assetLoaded() {
            loadedCount++;
            updateProgress();
            
            // إذا اكتمل التحميل بنجاح
            if (loadedCount === totalAssets && assetsErrors.length === 0) {
                finishLoadingSuccessfully();
            }
            // إذا اكتمل التحميل مع أخطاء
            else if (loadedCount >= totalAssets) {
                finishLoadingWithErrors();
            }
        }
        
        // دالة لبدء مهلة زمنية للتحميل
        function startLoadTimeout() {
            // إذا لم يكتمل التحميل خلال 10 ثوانٍ
            setTimeout(() => {
                if (loadedCount < totalAssets) {
                    assetsErrors.push({name: "مهلة زمنية", url: "تجاوزت عملية التحميل الوقت المحدد"});
                    finishLoadingWithErrors();
                }
            }, 10000);
        }
        
        // دالة عند اكتمال التحميل بنجاح
        function finishLoadingSuccessfully() {
            statusElement.textContent = "اكتمل التحميل بنجاح!";
            setTimeout(() => {
                loadingElement.style.opacity = '0';
                setTimeout(() => {
                    loadingElement.style.display = 'none';
                    changeScene('livingRoom');
                }, 500);
            }, 1000);
            assetsLoaded = true;
        }
        
        // دالة عند اكتمال التحميل مع أخطاء
        function finishLoadingWithErrors() {
            statusElement.textContent = "تم التحميل مع بعض الأخطاء";
            
            // بناء رسالة الخطأ
            let message = `حدث خطأ في تحميل ${assetsErrors.length} أصول:<br>`;
            assetsErrors.forEach(error => {
                message += `- ${error.name}: ${error.url}<br>`;
            });
            message += "قد تعمل الجولة مع بعض المشاكل.";
            
            errorMessage.innerHTML = message;
            errorMessage.style.display = 'block';
            retryButton.style.display = 'block';
            
            // إذا كان هناك ما يكفي من الأصول للبدء
            if (loadedCount > 3) {
                setTimeout(() => {
                    loadingElement.style.opacity = '0';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                        changeScene('livingRoom');
                    }, 500);
                }, 3000);
            }
        }
        
        // دالة إعادة المحاولة
        retryButton.addEventListener('click', () => {
            loadAssets();
        });

        // الانتقال بين المشاهد
        function changeScene(sceneId) {
            if (!scenes[sceneId]) {
                console.error(`المشهد ${sceneId} غير موجود`);
                return;
            }
            
            const scene = scenes[sceneId];
            const sky = document.querySelector('#sky');
            const hotspotContainer = document.querySelector('#hotspotContainer');
            const sceneTitle = document.getElementById('scene-title');
            
            // تحديث السماء
            sky.setAttribute('material', 'src', scene.image);
            
            // تحديث عنوان المشهد
            sceneTitle.textContent = scene.name;
            
            // إزالة النقاط القديمة
            hotspotContainer.innerHTML = '';
            
            // إضافة النقاط الجديدة
            scene.hotspots.forEach(hotspot => {
                if (!scenes[hotspot.target]) {
                    console.error(`المشهد الهدف ${hotspot.target} غير موجود`);
                    return;
                }
                
                const hotspotEl = document.createElement('a-entity');
                hotspotEl.setAttribute('class', 'hotspot');
                hotspotEl.setAttribute('position', hotspot.position);
                hotspotEl.setAttribute('look-at', '[camera]');
                
                // إنشاء الصورة
                const image = document.createElement('a-image');
                image.setAttribute('src', hotspotImageNormal.src);
                image.setAttribute('width', 0.5);
                image.setAttribute('height', 0.5);
                hotspotEl.appendChild(image);
                
                // تأثيرات المرور
                hotspotEl.addEventListener('mouseenter', () => {
                    image.setAttribute('src', hotspotImageHover.src);
                    image.setAttribute('width', 0.6);
                    image.setAttribute('height', 0.6);
                });
                
                hotspotEl.addEventListener('mouseleave', () => {
                    image.setAttribute('src', hotspotImageNormal.src);
                    image.setAttribute('width', 0.5);
                    image.setAttribute('height', 0.5);
                });
                
                // التسمية
                const label = document.createElement('a-text');
                label.setAttribute('value', hotspot.label);
                label.setAttribute('position', '0 0.6 0');
                label.setAttribute('color', '#FFF');
                label.setAttribute('align', 'center');
                label.setAttribute('visible', 'false');
                label.setAttribute('look-at', '[camera]');
                hotspotEl.appendChild(label);
                
                // إظهار التسمية عند المرور
                hotspotEl.addEventListener('mouseenter', () => {
                    label.setAttribute('visible', 'true');
                });
                
                hotspotEl.addEventListener('mouseleave', () => {
                    label.setAttribute('visible', 'false');
                });
                
                // النقلة عند النقر
                hotspotEl.addEventListener('click', () => {
                    if (audioElement) {
                        audioElement.currentTime = 0;
                        audioElement.play().catch(e => console.log("تشغيل الصوت:", e));
                    }
                    changeScene(hotspot.target);
                });
                
                hotspotContainer.appendChild(hotspotEl);
            });
        }

        // بدء التحميل عند تهيئة المشهد
        document.querySelector('a-scene').addEventListener('loaded', () => {
            loadAssets();
        });
        
        // تفعيل الصوت بعد التفاعل الأول
        document.body.addEventListener('click', () => {
            if (assetsLoaded && audioElement) {
                audioElement.play().catch(e => console.log("التفعيل الأولي للصوت:", e));
            }
        }, { once: true });
        
        // حل بديل إذا لم يعمل حدث loaded
        setTimeout(() => {
            if (loadingElement.style.display !== 'none') {
                loadAssets();
            }
        }, 2000);
    </script>
</body>
</html>
