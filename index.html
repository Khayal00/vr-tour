<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Tour with Hover Glow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      body { margin: 0; }
      .hotspot { cursor: pointer; }
    </style>
  </head>
  <body>
    <a-scene>
      <a-entity id="cameraRig" camera look-controls position="0 1.6 0">
        <a-cursor
          rayOrigin="mouse"
          raycaster="objects: .hotspot"
          fuse="false"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat">
        </a-cursor>
      </a-entity>

      <a-sky id="sky" rotation="0 -90 0"></a-sky>
      <a-entity id="hotspotContainer"></a-entity>
      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3"></audio>
      </a-assets>
    </a-scene>

    <script>
      // معلومات المشاهد والـ hotspots كما عندك
      const scenes = {
        Living_Room: {
          src: 'assets/Living_Room.jpg',
          hotspots: [
            { target: 'Kitchen', position: '-3 1.6 4', img: 'assets/link2.png', size: 0.8 },
            { target: 'Reception', position: '-3 1.6 -1.7', img: 'assets/link.png', size: 0.6 },
            { target: 'Corridor', position: '3 1.6 3', img: 'assets/link1.png', size: 1 }
          ]
        },
        Kitchen: {
          src: 'assets/Kitchen.jpg',
          hotspots: [
            { target: 'Living_Room', position: '4 1.6 -7', img: 'assets/link2.png', size: 0.7 }
          ]
        },
        Reception: {
          src: 'assets/Reception.jpg',
          hotspots: [
            { target: 'Living_Room', position: '5 1.6 -1', img: 'assets/link.png', size: 0.6 }
          ]
        },
        Corridor: {
          src: 'assets/Corridor.jpg',
          hotspots: [
            { target: 'Bathroom', position: '3 1.6 -0.5', img: 'assets/link2.png', size: 0.9 },
            { target: 'Bedroom', position: '-0.2 1.6 -3.5', img: 'assets/link2.png', size: 0.7 },
            { target: 'Living_Room', position: '1 1.6 3', img: 'assets/link2.png', size: 0.8 }
          ]
        },
        Bathroom: {
          src: 'assets/Bathroom.jpg',
          hotspots: [
            { target: 'Corridor', position: '-1 1.6 4', img: 'assets/link1.png', size: 0.6 }
          ]
        },
        Bedroom: {
          src: 'assets/Bedroom.jpg',
          hotspots: [
            { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.7 }
          ]
        }
      };

      // ترجع dataURL لصورة توهج متدرج (تقدر تغير الألوان/حجم الكانفاس هنا)
      function makeGlowDataURL(size = 512, colorCenter = '255,240,200', colorMid = '255,220,150') {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
        grad.addColorStop(0, `rgba(${colorCenter}, 0.95)`);
        grad.addColorStop(0.25, `rgba(${colorMid}, 0.7)`);
        grad.addColorStop(0.5, `rgba(${colorMid}, 0.4)`);
        grad.addColorStop(1, `rgba(${colorMid}, 0)`);
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,size,size);
        return canvas.toDataURL();
      }

      function changeScene(sceneName) {
        const sceneData = scenes[sceneName];
        const audio = document.querySelector('#transitionSound');
        const hotspotContainer = document.querySelector('#hotspotContainer');
        const sceneEl = document.querySelector('a-scene');
        const FADE_DUR = 700; // مدة التلاشي بالملي ثانية

        // إنشاء sky جديد أمام الحالي مع شفافية 0
        const newSky = document.createElement('a-sky');
        newSky.setAttribute('rotation', '0 -90 0');
        newSky.setAttribute('material', 'src: url(' + sceneData.src + '); shader: flat; transparent: true; opacity: 0');
        newSky.setAttribute('id', 'sky-temp');
        sceneEl.appendChild(newSky);

        // نخفّض تدرجياً شواغل المشهد الحالي (الهوتسبوتات)
        const oldChildren = Array.from(hotspotContainer.children);
        oldChildren.forEach(child => {
          try {
            if (child.getAttribute('material')) {
              child.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: ' + FADE_DUR + '; easing: easeInOutQuad');
            }
            if (child.tagName.toLowerCase() === 'a-text') {
              // نصوص a-text لا تملك material.opacity بشكل ثابت في كل الحالات -> نخفيها بعد انتهاء الفيد
              setTimeout(() => { try { child.setAttribute('visible', 'false'); } catch(e){} }, FADE_DUR + 20);
            }
          } catch(e) { /* ignore */ }
        });

        // تلاشي السما الحالي إذا وُجد
        const currentSky = document.querySelector('#sky');
        if (currentSky) {
          let mat = currentSky.getAttribute('material') || '';
          // تأكد أن الخاصية transparent: true موجودة
          if (mat.indexOf('transparent: true') === -1) {
            if (mat.trim().charAt(0) === ';') mat = mat.trim().slice(1);
            currentSky.setAttribute('material', mat + '; transparent: true');
          }
          currentSky.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: ' + FADE_DUR + '; easing: easeInOutQuad');
        }

        // ارفع سما الجديد تدريجياً
        newSky.setAttribute('animation__fadein', 'property: material.opacity; to: 1; dur: ' + FADE_DUR + '; easing: easeInOutQuad');

        // شغّل صوت الانتقال
        audio.pause();
        audio.currentTime = 0;
        audio.play().catch(() => {});

        // بعد انتهاء التلاشي، نزيل القديم ونضع الهوتسبوتات الجديدة ثم نُظهرها بتلاشي دخول
        setTimeout(() => {
          try { if (currentSky) currentSky.parentNode.removeChild(currentSky); } catch(e){}
          newSky.setAttribute('id', 'sky');

          hotspotContainer.innerHTML = '';

          sceneData.hotspots.forEach((hs, idx) => {
            const glowId = 'glow-img-' + sceneName + '-' + idx + '-' + Date.now();
            const dataURL = makeGlowDataURL(512);
            const glowImg = document.createElement('img');
            glowImg.setAttribute('id', glowId);
            glowImg.setAttribute('src', dataURL);
            document.querySelector('a-assets').appendChild(glowImg);

            const el = document.createElement('a-plane');
            el.setAttribute('class', 'hotspot');
            el.setAttribute('position', hs.position);
            el.setAttribute('width', hs.size || 0.6);
            el.setAttribute('height', hs.size || 0.6);
            el.setAttribute('material', 'src: url(' + hs.img + '); transparent: true; shader: flat; opacity: 0');
            el.setAttribute('look-at', '#cameraRig');
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');

            const glow = document.createElement('a-plane');
            glow.setAttribute('position', hs.position);
            const glowScale = (hs.size || 0.6) * 1.2;
            glow.setAttribute('width', glowScale);
            glow.setAttribute('height', glowScale);
            glow.setAttribute('look-at', '#cameraRig');
            glow.setAttribute('material', 'src: #' + glowId + '; transparent: true; shader: flat; opacity: 0');
            glow.setAttribute('visible', 'false');

            const label = document.createElement('a-text');
            label.setAttribute('value', hs.target.replace('_', ' '));
            label.setAttribute('align', 'center');
            label.setAttribute('color', '#FFFFFF');
            label.setAttribute('width', 4);
            label.setAttribute('look-at', '#cameraRig');
            const pos = hs.position.split(' ');
            label.setAttribute('position', pos[0] + ' ' + (parseFloat(pos[1]) + 0.6) + ' ' + pos[2]);
            label.setAttribute('visible', 'false');

            el.addEventListener('mouseenter', () => {
              el.removeAttribute('animation__pulse');
              el.setAttribute('animation__hover', 'property: scale; to: 1.5 1.5 1.5; dur: 180; easing: easeOutQuad');
              label.setAttribute('visible', 'true');

              glow.setAttribute('visible', 'true');
              glow.removeAttribute('animation__fadeout');
              glow.setAttribute('animation__fadein', 'property: material.opacity; to: 0.85; dur: 200; easing: easeOutQuad');
              glow.removeAttribute('animation__glowscaleback');
              glow.setAttribute('animation__glowscale', 'property: scale; to: 1.25 1.25 1.25; dur: 200; easing: easeOutQuad');
            });

            el.addEventListener('mouseleave', () => {
              el.removeAttribute('animation__hover');
              el.setAttribute('scale', '1 1 1');
              el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
              label.setAttribute('visible', 'false');

              glow.removeAttribute('animation__fadein');
              glow.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: 300; easing: easeOutQuad');
              glow.removeAttribute('animation__glowscale');
              glow.setAttribute('animation__glowscaleback', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');

              setTimeout(() => { try { glow.setAttribute('visible', 'false'); } catch(e){} }, 320);
            });

            el.addEventListener('click', () => {
              audio.pause();
              audio.currentTime = 0;
              audio.play().catch(() => {});
              changeScene(hs.target);
            });

            hotspotContainer.appendChild(glow);
            hotspotContainer.appendChild(el);
            hotspotContainer.appendChild(label);

            // fade-in للـ hotspot الجديد
            setTimeout(() => {
              try {
                el.setAttribute('animation__fadein', 'property: material.opacity; to: 1; dur: ' + FADE_DUR + '; easing: easeInOutQuad');
              } catch(e) { }
            }, 50);
          });

        }, FADE_DUR + 20);
      }

      window.addEventListener('load', () => {
        document.body.addEventListener('click', () => {
          const audio = document.querySelector('#transitionSound');
          audio.play().catch(() => {});
        }, { once: true });

        changeScene('Living_Room');
      });
    </script>
  </body>
</html>
