<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>جولة افتراضية - هوت سبوتات متعددة الصور</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      background: #000;
      color: #fff;
      direction: rtl;
    }
    
    /* شاشة التحميل */
    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: #fff;
      z-index: 100;
      flex-direction: column;
      gap: 20px;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    #welcomeBox {
      text-align: center;
      max-width: 800px;
      padding: 30px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    
    #title {
      font-size: 42px;
      margin-bottom: 15px;
      background: linear-gradient(to right, #ff8a00, #da1b60);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
      letter-spacing: 1px;
    }
    
    #subtitle {
      font-size: 20px;
      opacity: 0.9;
      line-height: 1.6;
      margin-bottom: 25px;
    }
    
    #progressBar {
      width: 80%;
      height: 18px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      overflow: hidden;
      margin: 25px auto;
    }
    
    #progressFill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #00c9ff, #92fe9d);
      transition: width 400ms ease;
      border-radius: 10px;
    }
    
    #startBtn {
      margin-top: 20px;
      padding: 14px 45px;
      border-radius: 50px;
      border: none;
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
      color: white;
      cursor: pointer;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
    }
    
    #startBtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 75, 43, 0.6);
    }
    
    #startBtn:active {
      transform: translateY(1px);
    }
    
    #instructions {
      font-size: 16px;
      opacity: 0.85;
      margin-top: 25px;
      line-height: 1.6;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
    }
    
    .scene-info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px 25px;
      border-radius: 15px;
      font-size: 22px;
      font-weight: 700;
      color: #ffcc00;
      z-index: 50;
      backdrop-filter: blur(5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    
    @media (max-width: 768px) {
      #title { font-size: 32px; }
      #subtitle { font-size: 17px; }
      #welcomeBox { padding: 20px; max-width: 90%; }
      .scene-info { font-size: 18px; padding: 10px 15px; }
    }
    
    @media (max-width: 480px) {
      #title { font-size: 26px; }
      #subtitle { font-size: 15px; }
      #startBtn { padding: 12px 30px; font-size: 18px; }
      .scene-info { font-size: 16px; padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div id="overlay">
    <div id="welcomeBox">
      <div id="title">جولة افتراضية في منزل الأحلام</div>
      <div id="subtitle">
        استكشف هذا المنزل الرائع بتقنية الواقع الافتراضي 360 درجة. اضغط على النقاط الساخنة لاكتشاف المزيد من الصور لكل منطقة.<br>
        يمكنك استخدام نظارات VR (ميتا كويست)، الموبايل، أو الكمبيوتر.
      </div>
      
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
      <div id="progressText" style="margin-top: 12px; font-size: 18px;">
        جارٍ تحميل الصور: <span id="percent">0%</span>
      </div>
      
      <button id="startBtn" disabled>
        <i class="fas fa-play" style="margin-left: 10px;"></i> ابدأ الجولة
      </button>
      
      <div id="instructions">
        <i class="fas fa-info-circle" style="margin-left: 8px;"></i> 
        للتحكم: استخدم اللمس على الموبايل، النقر بالماوس على الكمبيوتر، أو ذراع التحكم في نظارة VR.<br>
        يمكنك إضافة صور مختلفة لكل نقطة ساخنة بسهولة.
      </div>
    </div>
  </div>
  
  <!-- معلومات المشهد الحالي -->
  <div class="scene-info" id="sceneInfo" style="display: none;">الاستقبال</div>
  
  <!-- مشهد A-Frame -->
  <a-scene background="color: #000" vr-mode-ui="enabled: true">
    <a-entity id="cameraRig">
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-entity id="gazeCursor"
          cursor="fuse: true; fuseTimeout: 1000"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: white; shader: flat; opacity:0.9;">
        </a-entity>
      </a-entity>
      
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
    </a-entity>
    
    <a-sky id="skyA" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:1"></a-sky>
    <a-sky id="skyB" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:0"></a-sky>
    
    <!-- HOTSPOTS ROOT -->
    <a-entity id="hotspotsRoot" visible="true"></a-entity>
    
    <a-entity id="desktopCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable" visible="false"></a-entity>
  </a-scene>

  <script>
    // ---------- CONFIG ----------
    const scenes = {
      "lobby": {
        image: "https://images.unsplash.com/photo-1615529162924-f8605388463a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "الاستقبال"
      },
      "living_room": {
        image: "https://images.unsplash.com/photo-1616486029423-aaa4789e8c9a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "الصالة"
      },
      "kitchen": {
        image: "https://images.unsplash.com/photo-1600566752355-35792bedcfea?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "المطبخ"
      },
      "corridor": {
        image: "https://images.unsplash.com/photo-1598928636135-d146006ff4be?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "الممر"
      },
      "bedroom": {
        image: "https://images.unsplash.com/photo-1616486029423-aaa4789e8c9a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "غرفة النوم"
      },
      "bathroom": {
        image: "https://images.unsplash.com/photo-1630569461395-8d60247cb0ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80",
        name: "الحمام"
      }
    };

    // هنا يمكنك إضافة صورة مختلفة لكل نقطة هوت سبوت
    const hotspotsData = {
      "lobby": [
        { 
          label: "الصالة", 
          target: "living_room", 
          lat: 0, 
          lon: 60,
          image: "assets/link.png"
        },
        { 
          label: "المكتب", 
          target: "bedroom", 
          lat: -10, 
          lon: -60,
          image: "assets/link1.png"
        }
      ],
      "kitchen": [
        { 
          label: "الصالة", 
          target: "living_room", 
          lat: 10, 
          lon: -80,
          image: "https://images.unsplash.com/photo-1556911220-ef412ae179a9?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "المخزن", 
          target: "lobby", 
          lat: -5, 
          lon: 120,
          image: "https://images.unsplash.com/photo-1617103996702-96ff29b1c467?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        }
      ],
      "corridor": [
        { 
          label: "الصالة", 
          target: "living_room", 
          lat: 0, 
          lon: 160,
          image: "https://images.unsplash.com/photo-1584622650111-993a426fbf0a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "غرفة النوم", 
          target: "bedroom", 
          lat: 5, 
          lon: -30,
          image: "https://images.unsplash.com/photo-1513694203232-719a280e022f?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "الحمام", 
          target: "bathroom", 
          lat: -5, 
          lon: -60,
          image: "https://images.unsplash.com/photo-1564540583246-934409427776?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        }
      ],
      "living_room": [
        { 
          label: "الاستقبال", 
          target: "lobby", 
          lat: 0, 
          lon: -110,
          image: "https://images.unsplash.com/photo-1584622650111-993a426fbf0a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "المطبخ", 
          target: "kitchen", 
          lat: 10, 
          lon: 60,
          image: "https://images.unsplash.com/photo-1600566753086-00f18fb6b4ea?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "الممر", 
          target: "corridor", 
          lat: -5, 
          lon: 150,
          image: "https://images.unsplash.com/photo-1598928636135-d146006ff4be?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        }
      ],
      "bedroom": [
        { 
          label: "الممر", 
          target: "corridor", 
          lat: 0, 
          lon: 120,
          image: "https://images.unsplash.com/photo-1615529162924-f8605388463a?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        },
        { 
          label: "الحمام", 
          target: "bathroom", 
          lat: -10, 
          lon: -30,
          image: "https://images.unsplash.com/photo-1564540583246-934409427776?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        }
      ],
      "bathroom": [
        { 
          label: "الممر", 
          target: "corridor", 
          lat: 0, 
          lon: -140,
          image: "https://images.unsplash.com/photo-1630569461395-8d60247cb0ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80"
        }
      ]
    };

    const initialScene = "lobby";

    // ---------- PRELOADER ----------
    const overlay = document.getElementById('overlay');
    const progressFill = document.getElementById('progressFill');
    const percentText = document.getElementById('percent');
    const startBtn = document.getElementById('startBtn');
    
    // جمع جميع عناوين الصور
    let allImages = Object.values(scenes).map(scene => scene.image);
    
    // جمع صور الهوت سبوتات
    Object.values(hotspotsData).forEach(hotspots => {
      hotspots.forEach(hotspot => {
        if (hotspot.image) {
          allImages.push(hotspot.image);
        }
      });
    });
    
    // إزالة التكرارات
    allImages = [...new Set(allImages)];
    
    let loadedCount = 0;
    function preloadImages(urls, onComplete, onProgress){
      urls.forEach(url => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => { 
          loadedCount++; 
          onProgress(loadedCount, urls.length); 
          if(loadedCount === urls.length) onComplete(); 
        };
        img.onerror = () => { 
          console.warn('Failed to load', url); 
          loadedCount++; 
          onProgress(loadedCount, urls.length); 
          if(loadedCount === urls.length) onComplete(); 
        };
        img.src = url;
      });
    }

    preloadImages(allImages, () => {
      startBtn.disabled = false;
      startBtn.innerHTML = '<i class="fas fa-play" style="margin-left: 10px;"></i> ابدأ الجولة الآن!';
    }, (loaded, total) => {
      const pct = Math.round(loaded/total*100);
      progressFill.style.width = pct + "%";
      percentText.innerText = pct + "%";
    });

    startBtn.addEventListener('click', () => {
      overlay.style.display = 'none';
      document.getElementById('sceneInfo').style.display = 'block';
      enterScene(initialScene);
    });
    
    document.addEventListener('keydown', e => {
      if((e.key === 'Enter' || e.key === ' ') && !startBtn.disabled){
        overlay.style.display = 'none';
        document.getElementById('sceneInfo').style.display = 'block';
        enterScene(initialScene);
      }
    });

    // ---------- UTILS ----------
    function latLonToCartesian(latDeg, lonDeg, radius){
      const lat = latDeg * Math.PI/180;
      const lon = lonDeg * Math.PI/180;
      const x = radius * Math.cos(lat) * Math.sin(lon);
      const y = radius * Math.sin(lat);
      const z = radius * Math.cos(lat) * Math.cos(lon) * -1;
      return { x, y, z };
    }

    // ---------- HOTSPOTS ----------
    const sceneEl = document.querySelector('a-scene');
    const skyA = document.getElementById('skyA');
    const skyB = document.getElementById('skyB');
    let activeSky = skyA;
    let inactiveSky = skyB;
    const hotspotsRoot = document.getElementById('hotspotsRoot');

    function makeHotspot(h) {
      const hotspot = document.createElement('a-entity');
      hotspot.classList.add('clickable');
      
      // إنشاء رمز الهوت سبوت باستخدام الصورة المخصصة
      const icon = document.createElement('a-entity');
      
      if (h.image) {
        // إذا كانت هناك صورة مخصصة، استخدمها
        icon.setAttribute('geometry', 'primitive: circle; radius: 0.2');
        icon.setAttribute('material', `shader: flat; src: url(${h.image}); transparent: true; opacity: 0.9`);
      } else {
        // إذا لم توجد صورة، استخدم الشكل الافتراضي
        icon.setAttribute('geometry', 'primitive: circle; radius: 0.15');
        icon.setAttribute('material', 'shader: flat; color: #FF9800; transparent: true; opacity: 0.9');
      }
      
      icon.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1200; easing: easeInOutSine; loop: true; to: 1.3 1.3 1.3; from: 0.9 0.9 0.9');
      
      // إنشاء شعاع ضوئي تحت الرمز
      const beam = document.createElement('a-entity');
      beam.setAttribute('geometry', 'primitive: cylinder; height: 1; radius: 0.05; openEnded: true');
      beam.setAttribute('material', 'shader: flat; color: #FF5722; transparent: true; opacity: 0.4');
      beam.setAttribute('position', '0 -0.5 0');
      beam.setAttribute('rotation', '90 0 0');
      
      hotspot.appendChild(icon);
      hotspot.appendChild(beam);
      
      hotspot.setAttribute('look-at', '#camera');
      hotspot.setAttribute('shadow', 'receive: false;cast:false');
      hotspot.setAttribute('visible', true);

      // تأثير التمرير
      hotspot.addEventListener('mouseenter', () => {
        icon.setAttribute('animation__hover', 'property: scale; to: 1.8 1.8 1.8; dur: 200; easing: easeOutQuad');
        if (!h.image) {
          icon.setAttribute('material', 'color', '#FF5722');
        }
      });
      
      hotspot.addEventListener('mouseleave', () => {
        icon.setAttribute('animation__hover', 'property: scale; to: 1 1 1; dur: 250; easing: easeOutQuad');
        if (!h.image) {
          icon.setAttribute('material', 'color', '#FF9800');
        }
      });

      // النقر للانتقال إلى المشهد الهدف
      const triggerNavigate = () => {
        const tgt = hotspot.getAttribute('data-target');
        if (tgt) {
          disableHotspots();
          hotspotsRoot.setAttribute('visible', 'false');
          fadeToScene(tgt);
        }
      };
      
      hotspot.addEventListener('click', triggerNavigate);
      hotspot.addEventListener('triggerdown', triggerNavigate);

      return hotspot;
    }

    function disableHotspots() {
      hotspotsRoot.querySelectorAll('.clickable').forEach(el => {
        el.classList.remove('clickable');
        el.classList.add('disabled');
      });
    }
    
    function enableHotspots() {
      hotspotsRoot.querySelectorAll('.disabled').forEach(el => {
        el.classList.remove('disabled');
        el.classList.add('clickable');
      });
    }

    function buildHotspotsFor(sceneName) {
      // تحديث معلومات المشهد
      document.getElementById('sceneInfo').textContent = scenes[sceneName].name;
      
      // إزالة أي هوت سبوتات سابقة
      while (hotspotsRoot.firstChild) hotspotsRoot.removeChild(hotspotsRoot.firstChild);

      const list = hotspotsData[sceneName] || [];
      list.forEach(h => {
        const pos = latLonToCartesian(h.lat || 0, h.lon || 0, 3.5);
        const ent = makeHotspot(h);
        ent.setAttribute('position', `${pos.x.toFixed(3)} ${pos.y.toFixed(3)} ${pos.z.toFixed(3)}`);
        ent.setAttribute('data-target', h.target);
        hotspotsRoot.appendChild(ent);
      });
    }

    // ---------- CROSSFADE ----------
    let isTransitioning = false;
    async function fadeToScene(targetName) {
      if (isTransitioning) return;
      if (!scenes[targetName]) {
        console.warn('Unknown scene target:', targetName);
        hotspotsRoot.setAttribute('visible', 'true');
        enableHotspots();
        return;
      }
      isTransitioning = true;
      const fadeDur = 800;

      // إخفاء الهوت سبوتات
      hotspotsRoot.setAttribute('visible', 'false');

      // تنظيف الرسوم المتحركة السابقة
      inactiveSky.removeAttribute('animation__in');
      activeSky.removeAttribute('animation__out');

      // تعيين نسيج جديد للسماء الخاملة
      inactiveSky.setAttribute('material',
        `src: ${scenes[targetName].image}; shader: flat; transparent: true; side: double; opacity: 0`
      );

      // ضمان وجود مادة متسقة للسماء النشطة
      activeSky.setAttribute('material', `shader: flat; transparent: true; side: double; opacity: 1`);

      // الرسوم المتحركة للتلاشي
      inactiveSky.setAttribute('animation__in',
        `property: material.opacity; to: 1; dur: ${fadeDur}; easing: easeInOutQuad`
      );
      activeSky.setAttribute('animation__out',
        `property: material.opacity; to: 0; dur: ${fadeDur}; easing: easeInOutQuad`
      );

      // الانتظار حتى انتهاء الرسوم المتحركة
      await new Promise(resolve => setTimeout(resolve, fadeDur + 50));

      // تثبيت الشفافية وتبديل المراجع
      activeSky.setAttribute('material', 'opacity', 0);
      inactiveSky.setAttribute('material', 'opacity', 1);

      const tmp = activeSky;
      activeSky = inactiveSky;
      inactiveSky = tmp;

      // إزالة سمات الرسوم المتحركة
      activeSky.removeAttribute('animation__in');
      inactiveSky.removeAttribute('animation__out');

      // إعادة بناء الهوت سبوتات للمشهد الجديد
      buildHotspotsFor(targetName);

      // تأخير صغير لإظهار الهوت سبوتات
      await new Promise(resolve => setTimeout(resolve, 100));
      hotspotsRoot.setAttribute('visible', 'true');
      enableHotspots();
      isTransitioning = false;
    }

    // ---------- ENTER SCENE ----------
    function enterScene(sceneName) {
      if (!scenes[sceneName]) {
        console.error('Initial scene not found:', sceneName);
        return;
      }
      // تعيين السماء النشطة والشفافية
      activeSky.setAttribute('material', `src: ${scenes[sceneName].image}; shader: flat; transparent: true; side: double; opacity: 1`);
      inactiveSky.setAttribute('material', `shader: flat; transparent: true; side: double; opacity: 0`);
      buildHotspotsFor(sceneName);

      // إظهار مؤشر الماوس على سطح المكتب فقط
      const deskCursor = document.getElementById('desktopCursor');
      if (AFRAME.utils.device.isDesktop()) {
        deskCursor.setAttribute('visible', true);
      } else {
        deskCursor.setAttribute('visible', false);
      }
    }

    sceneEl.addEventListener('loaded', () => {
      activeSky.setAttribute('material', 'shader: flat; transparent: true; side: double;');
      inactiveSky.setAttribute('material', 'shader: flat; transparent: true; side: double;');
    });

    window.vrTour = { enterScene, fadeToScene, hotspotsData, scenes };

    if (overlay.style.display === 'none') enterScene(initialScene);
  </script>
</body>
</html>
