<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Test - Oculus Quest Fuse + Laser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
</head>
<body>
<a-scene>
  <!-- Camera with gaze cursor -->
  <a-entity id="cameraRig" camera look-controls position="0 1.6 0">
    <a-cursor fuse="true" fuse-timeout="1000"
              raycaster="objects: .hotspot"
              geometry="primitive:ring; radiusInner:0.02; radiusOuter:0.03"
              material="color:white; shader:flat">
    </a-cursor>
  </a-entity>

  <!-- Laser controls for Oculus Quest -->
  <a-entity laser-controls="hand: right" raycaster="objects: .hotspot" cursor="fuse:true; fuseTimeout:1000"></a-entity>
  <a-entity laser-controls="hand: left"  raycaster="objects: .hotspot" cursor="fuse:true; fuseTimeout:1000"></a-entity>

  <!-- Skies -->
  <a-sky id="skyFront" src="#img1" material="shader:flat; transparent:true; opacity:1"></a-sky>
  <a-sky id="skyBack" material="shader:flat; transparent:true; opacity:0"></a-sky>

  <!-- Hotspot container -->
  <a-entity id="hotspotContainer"></a-entity>

  <a-assets>
    <img id="img1" src="assets/Living_Room.jpg">
    <img id="img2" src="assets/Kitchen.jpg">
  </a-assets>
</a-scene>

<script>
const scenes = {
  Living_Room: { src:'#img1', hotspots:[{target:'Kitchen', position:'0 1.6 -3', img:'assets/link.png', size:0.6}] },
  Kitchen:     { src:'#img2', hotspots:[{target:'Living_Room', position:'0 1.6 -3', img:'assets/link.png', size:0.6}] }
};

function createHotspots(sceneName){
  const container=document.querySelector('#hotspotContainer'); container.innerHTML='';
  const scene=scenes[sceneName]||{hotspots:[]};
  scene.hotspots.forEach(hs=>{
    const el=document.createElement('a-plane'); el.className='hotspot';
    el.setAttribute('position',hs.position); el.setAttribute('width',hs.size); el.setAttribute('height',hs.size);
    el.setAttribute('material',`src:${hs.img}; transparent:true; shader:flat`); el.setAttribute('look-at','#cameraRig');
    el.addEventListener('click',()=>changeScene(hs.target));
    el.addEventListener('fuse',()=>changeScene(hs.target));
    container.appendChild(el);
  });
}

function changeScene(sceneName){
  const skyFront=document.querySelector('#skyFront'); const skyBack=document.querySelector('#skyBack');
  skyBack.setAttribute('src', scenes[sceneName].src); skyBack.setAttribute('opacity',0); skyBack.setAttribute('visible',true);
  // crossfade simple
  let t=0; const dur=600;
  function step(){
    t+=16; let p=Math.min(1,t/dur);
    skyBack.setAttribute('opacity',p); skyFront.setAttribute('opacity',1-p);
    if(p<1){requestAnimationFrame(step);} else{
      skyFront.setAttribute('src', scenes[sceneName].src); skyFront.setAttribute('opacity',1); skyBack.setAttribute('opacity',0);
      createHotspots(sceneName);
    }
  }
  step();
}

// ابدأ بالمشهد الأول
createHotspots('Living_Room');
</script>
</body>
</html>
