<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>VR 360 Tour - A-Frame (Crossfade) - مدموج</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; direction: rtl; }
    #overlay {
      position: absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(0deg, rgba(0,0,0,0.85), rgba(0,0,0,0.6));
      color:#fff; z-index:10; flex-direction:column; gap:18px;
    }
    #welcomeBox { text-align:center; max-width:720px; padding:20px; }
    #title { font-size:28px; margin-bottom:8px; }
    #subtitle { font-size:16px; opacity:0.9; }
    #progressBar {
      width:80%; height:14px; background:rgba(255,255,255,0.15); border-radius:8px; overflow:hidden; margin-top:16px;
    }
    #progressFill { width:0%; height:100%; background:linear-gradient(90deg, rgba(255,255,255,0.18), rgba(255,255,255,0.32)); transition:width 200ms ease; }
    #startBtn {
      margin-top:14px; padding:10px 18px; border-radius:8px; border:none; background:#1e90ff; color:white; cursor:pointer;
      font-size:16px;
    }
    #instructions { font-size:13px; opacity:0.9; margin-top:10px; }
    @media (max-width:600px){ #title{font-size:22px;} #subtitle{font-size:14px;} }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="welcomeBox">
      <div id="title">مرحباً بكم في الجولة الافتراضية</div>
      <div id="subtitle">التجربة تعمل على نظارات VR (Meta Quest) والموبايل والكمبيوتر — مرّر المؤشر على النقاط لتعريف المكان، واضغط أو انظر للنقطة للانتقال.</div>

      <div id="progressBar"><div id="progressFill"></div></div>
      <div id="progressText" style="margin-top:8px;">تحميل الصور: <span id="percent">0%</span></div>

      <button id="startBtn" disabled>ابدأ الجولة</button>
      <div id="instructions" style="margin-top:8px;">
        تحكم: لمس / نقرة / المؤشر على الكمبيوتر — أو استخدم ذراع تحكم النظارة (laser).<br>
        يمكنك تعديل مواقع الهوتسبوت في الكود ضمن مصفوفة `hotspotsData`.
      </div>
    </div>
  </div>

  <a-scene background="color: #000" vr-mode-ui="enabled: true">
    <a-entity id="cameraRig">
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-entity id="gazeCursor"
          cursor="fuse: true; fuseTimeout: 1000"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: white; shader: flat; opacity:0.9;">
        </a-entity>
      </a-entity>

      <a-entity laser-controls="hand: right" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
    </a-entity>

    <a-sky id="skyA" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:1"></a-sky>
    <a-sky id="skyB" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:0"></a-sky>

    <!-- HOTSPOTS ROOT: نتحكم في ظهوره لإخفاء العناصر أثناء التلاشي -->
    <a-entity id="hotspotsRoot" visible="true"></a-entity>

    <a-entity id="desktopCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable" visible="false"></a-entity>
  </a-scene>

    <script>
      // تعريف المشاهد والهوت سبوت
      const scenes = {
        Living_Room: {
          src: '#imgLiving',
          hotspots: [
            { target: 'Kitchen',   position: '-3 1.6 4',   img: 'assets/link2.png', size: 0.6 },
            { target: 'Reception', position: '-3 1.6 -1.7', img: 'assets/link.png',  size: 0.6 },
            { target: 'Corridor',  position: '3 1.6 3',    img: 'assets/link1.png', size: 0.6 }
          ]
        },
        Kitchen:    { src: '#imgKitchen',   hotspots: [ { target: 'Living_Room', position: '4 1.6 -7', img: 'assets/link2.png', size: 0.8 } ] },
        Reception:  { src: '#imgReception', hotspots: [ { target: 'Living_Room', position: '5 1.6 -1',  img: 'assets/link.png',  size: 0.6 } ] },
        Corridor: {
          src: '#imgCorridor',
          hotspots: [
            { target: 'Bathroom',   position: '3 1.6 -0.5',  img: 'assets/link2.png', size: 0.6 },
            { target: 'Bedroom',    position: '-0.2 1.6 -3.5',img: 'assets/link2.png', size: 0.6 },
            { target: 'Living_Room',position: '1 1.6 3',     img: 'assets/link2.png', size: 0.6 }
          ]
        },
        Bathroom:   { src: '#imgBathroom',  hotspots: [ { target: 'Corridor', position: '-1 1.6 4', img: 'assets/link1.png', size: 0.6 } ] },
        Bedroom:    { src: '#imgBedroom',   hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.6 } ] }
      };

      // رسم توهج ديناميكي
      function makeGlowDataURL(size = 512, colorCenter = '255,240,200', colorMid = '0,128,255') {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
        grad.addColorStop(0, `rgba(${colorCenter}, 0.95)`);
        grad.addColorStop(0.25, `rgba(${colorMid}, 0.7)`);
        grad.addColorStop(0.5, `rgba(${colorMid}, 0.4)`);
        grad.addColorStop(1, `rgba(${colorMid}, 0)`);
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,size,size);
        return canvas.toDataURL();
      }

      // إنشاء هوت سبوتات المشهد
      function createHotspots(sceneName) {
        const hotspotContainer = document.querySelector('#hotspotContainer');
        hotspotContainer.innerHTML = '';
        const scene = scenes[sceneName] || { hotspots: [] };

        scene.hotspots.forEach((hs, idx) => {
          // توليد صورة التوهج داخل a-assets
          const glowId = `glow-img-${sceneName}-${idx}-${Date.now()}`;
          const dataURL = makeGlowDataURL(512);
          const glowImg = document.createElement('img');
          glowImg.setAttribute('id', glowId);
          glowImg.setAttribute('src', dataURL);
          document.querySelector('a-assets').appendChild(glowImg);

          // الهوت سبوت (Icon)
          const el = document.createElement('a-plane');
          el.setAttribute('class', 'hotspot');
          el.setAttribute('position', hs.position);
          el.setAttribute('width', hs.size || 0.6);
          el.setAttribute('height', hs.size || 0.6);
          el.setAttribute('material', `src: url(${hs.img}); transparent: true; shader: flat; opacity: 1`);
          el.setAttribute('look-at', '#cameraRig');

          // 👇 يبدأ صغيرًا ثم يكبر (Pop-in)
          el.setAttribute('scale', '0 0 0');
          el.setAttribute('animation__popin', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');
          el.addEventListener('animationcomplete__popin', () => {
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
          });

          // التوهج
          const glow = document.createElement('a-plane');
          glow.setAttribute('position', hs.position);
          const glowScale = (hs.size || 0.6) * 1.2;
          glow.setAttribute('width', glowScale);
          glow.setAttribute('height', glowScale);
          glow.setAttribute('look-at', '#cameraRig');
          glow.setAttribute('material', `src: #${glowId}; transparent: true; shader: flat; depthTest: false; opacity: 0`);
          glow.setAttribute('visible', 'false');

          // اللابل
          const label = document.createElement('a-text');
          label.setAttribute('value', hs.target.replace('_', ' '));
          label.setAttribute('align', 'center');
          label.setAttribute('color', '#FFFFFF');
          label.setAttribute('width', 4);
          label.setAttribute('look-at', '#cameraRig');
          const pos = hs.position.split(' ');
          label.setAttribute('position', `${pos[0]} ${parseFloat(pos[1]) + 0.6} ${pos[2]}`);
          label.setAttribute('scale', '0 0 0');
          label.setAttribute('visible', 'true');

          // تفاعلات الماوس
          el.addEventListener('mouseenter', () => {
            el.removeAttribute('animation__pulse');
            el.setAttribute('animation__hover', 'property: scale; to: 1.5 1.5 1.5; dur: 180; easing: easeOutQuad');
            label.removeAttribute('animation__scalefadeout');
            label.setAttribute('animation__scalefadein', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            glow.setAttribute('visible', 'true');
            glow.removeAttribute('animation__fadeout');
            glow.setAttribute('animation__fadein', 'property: material.opacity; to: 0.85; dur: 200; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscaleback');
            glow.setAttribute('animation__glowscale', 'property: scale; to: 1.25 1.25 1.25; dur: 200; easing: easeOutQuad');
          });

          el.addEventListener('mouseleave', () => {
            el.removeAttribute('animation__hover');
            el.setAttribute('scale', '1 1 1');
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
            label.removeAttribute('animation__scalefadein');
            label.setAttribute('animation__scalefadeout', 'property: scale; to: 0 0 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__fadein');
            glow.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscale');
            glow.setAttribute('animation__glowscaleback', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            setTimeout(() => { try { glow.setAttribute('visible', 'false'); } catch(e){} }, 320);
          });

          el.addEventListener('click', () => { changeScene(hs.target); });

          // ترتيب الإضافة مهم: التوهج ثم الأيقونة ثم اللابل
          const container = document.querySelector('#hotspotContainer');
          container.appendChild(glow);
          container.appendChild(el);
          container.appendChild(label);
        });
      }

      // ====== RAF-based crossfade ======
      let currentFadeRAF = null;

      // الوصول المباشر لمادة السماء لرفع الأداء
      function setSkyOpacity(skyEl, value) {
        try {
          const mesh = skyEl.getObject3D && skyEl.getObject3D('mesh');
          if (mesh && mesh.material) {
            mesh.material.transparent = true;
            mesh.material.opacity = value;
            mesh.material.needsUpdate = true;
            return;
          }
        } catch (e) {}
        skyEl.setAttribute('material', `shader: flat; transparent: true; opacity: ${value}`);
      }

      // تغيير المشهد + إخفاء الهوت سبوتات القديمة فورًا
      function changeScene(sceneName, duration = 700) {
        const skyFront = document.querySelector('#skyFront');
        const skyBack  = document.querySelector('#skyBack');
        const hotspotContainer = document.querySelector('#hotspotContainer');
        const audio = document.querySelector('#transitionSound');

        // إلغاء أي انتقال سابق
        if (currentFadeRAF) { cancelAnimationFrame(currentFadeRAF); currentFadeRAF = null; }

        // 👇 إخفاء كل الهوت سبوتات القديمة فورًا حتى لا تظهر بالمشهد التالي
        Array.from(hotspotContainer.children).forEach(el => {
          try {
            el.setAttribute('visible', 'false');
            el.removeAttribute('animation__pulse');
            el.removeAttribute('animation__hover');
            el.removeAttribute('animation__fadein');
            el.removeAttribute('animation__glowscale');
            el.removeAttribute('animation__scalefadein');
            el.removeAttribute('animation__popin');
          } catch(e){}
        });

        // حضّر صورة المشهد الجديد على skyBack
        skyBack.setAttribute('src', scenes[sceneName].src);
        setSkyOpacity(skyBack, 0);

        // شغّل صوت الانتقال (اختياري)
        try { audio.pause(); audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){}

        // ابدأ حلقة الـ RAF
        const start = performance.now();
        const dur = Math.max(50, duration);
        function step(now) {
          const t = Math.min(1, (now - start) / dur);
          const ease = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t; // easeInOut تقريبي
          setSkyOpacity(skyBack, ease);      // 0 → 1
          setSkyOpacity(skyFront, 1 - ease); // 1 → 0

          if (t < 1) {
            currentFadeRAF = requestAnimationFrame(step);
          } else {
            currentFadeRAF = null;
            // ثبّت المشهد الجديد في الأمام
            skyFront.setAttribute('src', scenes[sceneName].src);
            setSkyOpacity(skyFront, 1);
            setSkyOpacity(skyBack, 0);
            try { skyBack.removeAttribute('src'); } catch(e){}

            // حدث الـ HUD
            document.querySelector('#sceneLabel').setAttribute('value', sceneName.replace('_', ' '));

            // أنشئ هوت سبوتات المشهد الجديد
            createHotspots(sceneName);
          }
        }
        currentFadeRAF = requestAnimationFrame(step);
      }

      // ====== شاشة الترحيب + التحميل ======
      const assets = document.querySelector('a-assets');
      const progressBar = document.getElementById('progressBar');
      const startBtn = document.getElementById('startBtn');
      const welcomeScreen = document.getElementById('welcomeScreen');

      // قد لا يدعم بعض المتصفحات progressBytes، هذا فالباك بسيط
      assets.addEventListener('progress', (e) => {
        const loaded = e.detail && e.detail.loadedBytes ? e.detail.loadedBytes : 0;
        const total  = e.detail && e.detail.totalBytes  ? e.detail.totalBytes  : 0;
        const percent = total > 0 ? Math.floor((loaded/total)*100) : 0;
        progressBar.style.width = percent + '%';
      });

      assets.addEventListener('loaded', () => {
        progressBar.style.width = '100%';
        startBtn.style.display = 'block';
      });

      startBtn.addEventListener('click', () => {
        welcomeScreen.style.transition = 'opacity 0.7s';
        welcomeScreen.style.opacity = '0';
        setTimeout(() => { welcomeScreen.style.display = 'none'; }, 700);
        // ابدأ بالمشهد الأول
        changeScene('Living_Room', 800);
      });
    </script>
  </body>
</html>
