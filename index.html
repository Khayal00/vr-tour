<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>360 VR Tour â€” Meta Quest Ready</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    /* --- Welcome / Loader Overlay --- */
    #welcome {
      position: fixed; inset: 0; z-index: 9999;
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(1200px 800px at 50% 40%, #111 0%, #000 60%);
      color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .panel { width: min(720px, 92vw); padding: 28px; border-radius: 20px; background: rgba(255,255,255,0.04); backdrop-filter: blur(6px); box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    h1 { margin: 0 0 8px; font-weight: 800; letter-spacing: .3px; font-size: clamp(22px, 3.5vw, 34px); }
    .muted { color: #b8c0cc; line-height: 1.55; }
    .row { display: grid; gap: 14px; margin-top: 16px; }
    .hbar { height: 10px; width: 100%; background: rgba(255,255,255,.12); border-radius: 999px; overflow: hidden; }
    .fill { height: 100%; width: 0%; background: linear-gradient(90deg,#7bdcff,#5fb1ff); transition: width .25s ease; }
    .steps { font-size: 13px; color: #9fb0c7; display: grid; gap: 6px; margin-top: 10px; }
    .actions { display:flex; gap: 10px; margin-top: 14px; }
    .btn { cursor: pointer; padding: 10px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,.18); color:#0a0a0a; background: #7bdcff; font-weight: 700; }
    .btn.secondary { color: #e6eefc; background: transparent; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: rgba(255,255,255,.1); padding: 2px 6px; border-radius: 6px; }

    /* Tooltip chip styling shown above hotspot */
    .chip { background: rgba(0,0,0,.55); color:#fff; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25); font-size: 12px; letter-spacing: .2px; }

    /* Fade overlay during scene switches (DOM fallback for nonâ€‘VR) */
    #screenFade { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; transition: opacity .5s ease; z-index: 9998; }

    /* On-screen help (small) */
    #hint { position: fixed; left: 14px; bottom: 14px; z-index: 2; color: #e9eef7; font-size: 12px; font-family: system-ui; opacity: .85; }
  </style>
</head>
<body>
  <!-- Fade layer for desktop/mobile (A-Frame layer used in VR) -->
  <div id="screenFade"></div>

  <!-- Welcome / Loader -->
  <div id="welcome" role="dialog" aria-label="Welcome">
    <div class="panel">
      <h1>Welcome to the 360Â° VR Tour</h1>
      <p class="muted">Move between rooms using the pulsing hotspots. Works on Meta Quest, mobile, and desktop. Click <span class="kbd">Enter VR</span> for headset mode.</p>
      <div class="row">
        <div class="hbar" aria-label="Loading progress"><div id="prog" class="fill"></div></div>
        <div class="steps">
          <div>â€¢ Align your view, then point at a hotspot to jump between rooms.</div>
          <div>â€¢ Hover a hotspot to see its destination; it grows on hover.</div>
          <div>â€¢ Smooth fade between scenes keeps you oriented.</div>
        </div>
        <div class="actions">
          <button id="startBtn" class="btn">Start Tour</button>
          <button id="muteBtn" class="btn secondary">ðŸ”ˆ Sound: On</button>
        </div>
      </div>
    </div>
  </div>

  <div id="hint">Tip: press the goggles icon to enter VR on Meta Quest.</div>

  <!-- A-Frame Scene -->
  <a-scene renderer="antialias: true; colorManagement: true" vr-mode-ui="enabled: true" embedded>
    <a-assets id="assets">
      <!-- 360 images (place files in /assets) -->
      <img id="Reception"    src="assets/Reception.jpg"    crossorigin="anonymous" />
      <img id="Living_Room"  src="assets/Living_Room.jpg"  crossorigin="anonymous" />
      <img id="Kitchen"      src="assets/Kitchen.jpg"      crossorigin="anonymous" />
      <img id="Corridor"     src="assets/Corridor.jpg"     crossorigin="anonymous" />
      <img id="Bedroom"      src="assets/Bedroom.jpg"      crossorigin="anonymous" />
      <img id="Bathroom"     src="assets/Bathroom.jpg"     crossorigin="anonymous" />

      <!-- Hotspot PNG (pulsing circle or pin). Replace with your own PNG. -->
      <img id="hotspotImg" src="assets/hotspot.png" crossorigin="anonymous" />

      <!-- Optional intro / ambience audio -->
      <audio id="introAudio" src="assets/intro.mp3" preload="auto" crossorigin="anonymous"></audio>
    </a-assets>

    <!-- Sky for 360 pano -->
    <a-sky id="sky" radius="5000" rotation="0 -90 0" src="#Reception"></a-sky>

    <!-- Black plane child of camera for inâ€‘VR fade -->
    <a-entity id="fadeLayer" geometry="primitive: plane; height: 2; width: 2" material="color: #000; opacity: 0; shader: flat; transparent: true" position="0 0 -0.5" visible="false"></a-entity>

    <!-- Rig + camera + cursors (mouse and VR controllers) -->
    <a-entity id="rig">
      <a-entity id="camera" camera look-controls wasd-controls position="0 1.6 0"></a-entity>
      <!-- Desktop / Mobile mouse ray -->
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .hotspot"></a-entity>
      <!-- VR Controllers -->
      <a-entity laser-controls="hand: left" raycaster="objects: .hotspot"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .hotspot"></a-entity>
    </a-entity>

    <!-- Container for hotspots (re-populated each scene) -->
    <a-entity id="hotspots"></a-entity>
  </a-scene>

  <script>
    // ===== Helper: deg2rad
    const d2r = (d) => (d * Math.PI) / 180;

    // ===== Convert yaw/pitch (in degrees) on a sphere into XYZ position near the sky dome
    function hotspotPosition(yawDeg, pitchDeg, radius = 3) {
      // A-Frame uses Y up, Z forward. Yaw: around Y axis (0 is forward, + turns right). Pitch: positive up.
      const yaw = d2r(yawDeg);
      const pitch = d2r(pitchDeg);
      const x = -radius * Math.sin(yaw) * Math.cos(pitch);
      const y =  radius * Math.sin(pitch);
      const z = -radius * Math.cos(yaw) * Math.cos(pitch);
      return `${x.toFixed(3)} ${y.toFixed(3)} ${z.toFixed(3)}`;
    }

    // ===== Tour graph (your requested links)
    const LINKS = {
      Reception:    [{to: 'Living_Room', yaw:   0, pitch: -5}],
      Kitchen:      [{to: 'Living_Room', yaw:  30, pitch: -5}],
      Corridor:     [{to: 'Living_Room', yaw: -40, pitch: -6}, {to: 'Bedroom', yaw: 120, pitch: -4}, {to: 'Bathroom', yaw: -130, pitch: -4}],
      Living_Room:  [
        {to: 'Reception',  yaw: 180, pitch: -4},
        {to: 'Kitchen',    yaw:  85, pitch: -3},
        {to: 'Corridor',   yaw: -70, pitch: -3}
      ],
      Bedroom:      [{to: 'Corridor', yaw: -160, pitch: -5}],
      Bathroom:     [{to: 'Corridor', yaw:  140, pitch: -6}]
    };

    // ===== State
    let CURRENT = 'Reception';
    let audioEnabled = true;

    const sky = document.getElementById('sky');
    const hsRoot = document.getElementById('hotspots');
    const fadeLayer = document.getElementById('fadeLayer');

    // ===== Create a single hotspot (a-image + pulsing + hover scale + tooltip)
    function makeHotspot(fromScene, link, idx) {
      const wrap = document.createElement('a-entity');

      const img = document.createElement('a-image');
      img.setAttribute('src', '#hotspotImg');
      img.setAttribute('class', 'hotspot');
      img.setAttribute('look-at', '#camera');
      img.setAttribute('position', hotspotPosition(link.yaw, link.pitch, 3));
      img.setAttribute('scale', '0.9 0.9 0.9');
      img.setAttribute('transparent', 'true');
      img.setAttribute('alpha-test', '0.1');
      img.setAttribute('material', 'shader: flat; side: double;');

      // Pulse animation (always on)
      img.setAttribute('animation__pulse', 'property: scale; dir: alternate; loop: true; to: 1.15 1.15 1.15; dur: 900; easing: easeInOutSine');

      // Hover reactions (mouse/controller focus)
      img.addEventListener('mouseenter', () => {
        img.setAttribute('animation__hover', 'property: scale; to: 1.35 1.35 1.35; dur: 140; easing: easeOutQuad');
        tip.setAttribute('visible', true);
      });
      img.addEventListener('mouseleave', () => {
        img.removeAttribute('animation__hover');
        img.setAttribute('scale', '1.0 1.0 1.0');
        tip.setAttribute('visible', false);
      });

      // Click to switch scene
      img.addEventListener('click', () => switchScene(link.to));

      // Text label above the hotspot
      const tip = document.createElement('a-entity');
      tip.setAttribute('visible', 'false');
      tip.setAttribute('position', '0 0.35 0');
      tip.setAttribute('text', {
        value: link.to.replace(/_/g, ' '),
        align: 'center', color: '#FFFFFF', baseline: 'bottom',
        width: 2, wrapCount: 16
      });

      wrap.appendChild(img);
      wrap.appendChild(tip);
      return wrap;
    }

    // ===== Build hotspots for current scene
    function buildHotspots(sceneName) {
      hsRoot.innerHTML = '';
      (LINKS[sceneName] || []).forEach((link, i) => hsRoot.appendChild(makeHotspot(sceneName, link, i)));
    }

    // ===== Fade helpers
    function domFade(to = 1, dur = 400) {
      return new Promise(res => {
        const screen = document.getElementById('screenFade');
        screen.style.transition = `opacity ${dur}ms ease`;
        screen.style.opacity = String(to);
        setTimeout(res, dur + 20);
      });
    }
    function vrFade(to = 1, dur = 400) {
      return new Promise(res => {
        fadeLayer.setAttribute('visible', true);
        fadeLayer.setAttribute('animation__f', `property: material.opacity; to: ${to}; dur: ${dur}; easing: easeInOutQuad`);
        setTimeout(res, dur + 20);
      });
    }

    async function switchScene(next) {
      if (!next || next === CURRENT) return;
      // Parallel fade both DOM and in-VR plane (covers all modes smoothly)
      await Promise.all([ domFade(1, 400), vrFade(1, 400) ]);

      sky.setAttribute('src', `#${next}`);
      CURRENT = next;
      buildHotspots(CURRENT);

      // small delay to ensure texture swap, then fade back
      setTimeout(async () => {
        await Promise.all([ domFade(0, 420), vrFade(0, 420) ]);
        fadeLayer.setAttribute('visible', false);
      }, 60);
    }

    // ===== Assets loading -> progress bar
    const assets = document.getElementById('assets');
    const prog = document.getElementById('prog');
    let total = 0, loaded = 0;
    function updateProgress() {
      if (!total) return;
      const pct = Math.round((loaded / total) * 100);
      prog.style.width = pct + '%';
    }
    function watchNode(node) {
      if (node.tagName === 'IMG' || node.tagName === 'AUDIO' || node.tagName === 'VIDEO') {
        total++;
        const done = () => { loaded++; updateProgress(); };
        node.addEventListener('loadeddata', done, { once: true });
        node.addEventListener('loadedmetadata', done, { once: true });
        node.addEventListener('load', done, { once: true });
        node.addEventListener('error', done, { once: true });
      }
    }
    [...assets.children].forEach(watchNode);

    // ===== Welcome flow (start button)
    const startBtn = document.getElementById('startBtn');
    const muteBtn  = document.getElementById('muteBtn');
    const welcome  = document.getElementById('welcome');
    startBtn.addEventListener('click', () => {
      // Autoplay audio if available and not muted
      const a = document.getElementById('introAudio');
      if (a && audioEnabled) { a.loop = true; a.volume = 0.4; a.play().catch(()=>{}); }
      welcome.style.opacity = '0';
      setTimeout(()=> welcome.style.display = 'none', 300);
      buildHotspots(CURRENT);
      domFade(0, 0); // ensure hidden
      vrFade(0, 0);
    });
    muteBtn.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      muteBtn.textContent = audioEnabled ? 'ðŸ”ˆ Sound: On' : 'ðŸ”‡ Sound: Off';
      const a = document.getElementById('introAudio');
      if (!a) return;
      if (!audioEnabled) { try { a.pause(); } catch (_){} }
      else { try { a.play(); } catch (_){} }
    });

    // ===== Initial hotspots for default scene
    window.addEventListener('DOMContentLoaded', () => {
      buildHotspots(CURRENT);
    });
  </script>

  <!-- Look-at component (tiny inline version) -->
  <script>
    AFRAME.registerComponent('look-at', {
      schema: { type: 'selector' },
      tick: function(){
        const t = this.data || document.querySelector('#camera');
        if (!t) return;
        this.el.object3D.lookAt(t.object3D.position);
      }
    });
  </script>
</body>
</html>
