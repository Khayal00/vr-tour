<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>جولة افتراضية بتقنية VR - تجربة غامرة وسلسة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        margin: 0;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #000;
      }

      /* شاشة الترحيب */
      #welcomeScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a1a, #000000);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 9999;
        transition: opacity 0.8s ease-out, transform 0.8s ease-out;
      }
      
      #welcomeScreen.hidden {
        opacity: 0;
        transform: scale(1.1);
        pointer-events: none;
      }
      
      .logo {
        font-size: 3.5em;
        margin-bottom: 20px;
        text-shadow: 0 0 15px rgba(79, 172, 254, 0.8);
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
      }
      
      #instructions {
        font-size: 1.2em;
        margin-bottom: 30px;
        opacity: 0.85;
        text-align: center;
        max-width: 80%;
        line-height: 1.6;
      }
      
      .progress-container {
        width: 70%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        height: 22px;
        margin-bottom: 25px;
        box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
      }
      
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transition: width 0.4s ease-out;
        border-radius: 10px;
      }
      
      #startBtn {
        padding: 15px 40px;
        border: none;
        border-radius: 50px;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        color: white;
        font-size: 1.2em;
        cursor: pointer;
        display: none;
        margin-top: 20px;
        box-shadow: 0 5px 15px rgba(0, 242, 254, 0.4);
        transition: all 0.3s ease;
      }
      
      #startBtn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 242, 254, 0.6);
      }
      
      #startBtn:active {
        transform: translateY(1px);
      }
      
      .loading-text {
        margin-top: 15px;
        font-size: 0.9em;
        opacity: 0.7;
      }
      
      /* عناصر التحكم للجوال */
      #mobileControls {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 10;
        display: none;
        flex-direction: column;
        gap: 10px;
      }
      
      @media (max-width: 768px) {
        #mobileControls {
          display: flex;
        }
      }
      
      .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .control-btn:active {
        background: rgba(79, 172, 254, 0.8);
        transform: scale(0.95);
      }
      
      /* شاشة التحميل أثناء الانتقال */
      #transitionOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      #transitionOverlay.visible {
        opacity: 1;
      }
      
      .spinner {
        width: 70px;
        height: 70px;
        border: 5px solid rgba(79, 172, 254, 0.3);
        border-radius: 50%;
        border-top-color: #4facfe;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      
      .scene-name {
        position: absolute;
        bottom: 30%;
        left: 0;
        width: 100%;
        text-align: center;
        color: white;
        font-size: 2em;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.7);
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      
      #transitionOverlay.visible .scene-name {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <!-- شاشة الترحيب -->
    <div id="welcomeScreen">
      <div class="logo">✨ جولة افتراضية ✨</div>
      <div id="instructions">استخدم الماوس أو حرك هاتفك للنظر حولك في الجولة الافتراضية. انقر على الأيقونات للانتقال بين الغرف.</div>
      <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div id="loadingStatus" class="loading-text">جاري التحميل... 0%</div>
      <button id="startBtn">ابدأ الجولة</button>
    </div>

    <!-- عناصر التحكم للجوال -->
    <div id="mobileControls">
      <div class="control-btn" id="prevScene">←</div>
      <div class="control-btn" id="nextScene">→</div>
    </div>

    <!-- شاشة التحميل أثناء الانتقال -->
    <div id="transitionOverlay">
      <div class="spinner"></div>
      <div class="scene-name" id="nextSceneName"></div>
    </div>

    <!-- المشهد -->
    <a-scene>
      <a-entity id="cameraRig" camera look-controls position="0 1.6 0">
        <a-cursor
          id="cursor"
          rayOrigin="mouse"
          raycaster="objects: .hotspot"
          fuse="false"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat">
        </a-cursor>

        <!-- HUD -->
        <a-text id="sceneLabel" value="غرفة المعيشة" position="-1.2 0.8 -1"
          align="center" color="#FFFFFF" width="1"></a-text>

        <a-entity id="hudPlane" position="-1.2 0.8 -1">
          <a-plane width="0.3" height="0.1"
            material="color: #000000; opacity: 0.5; side: double; transparent: true">
          </a-plane>
        </a-entity>
      </a-entity>

      <!-- سماءان للـ crossfade -->
      <a-sky id="skyFront" rotation="0 -90 0" material="shader: flat; transparent: true; opacity: 1"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0" material="shader: flat; transparent: true; opacity: 0"></a-sky>

      <a-entity id="hotspotContainer"></a-entity>

      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3" preload="auto"></audio>
        <audio id="backgroundSound" src="assets/ambient.mp3" preload="auto" loop></audio>
        <audio id="clickSound" src="assets/click.mp3" preload="auto"></audio>
        
        <!-- صور المشاهد -->
        <img id="imgLiving" src="assets/Living_Room.jpg" crossorigin="anonymous">
        <img id="imgKitchen" src="assets/Kitchen.jpg" crossorigin="anonymous">
        <img id="imgReception" src="assets/Reception.jpg" crossorigin="anonymous">
        <img id="imgCorridor" src="assets/Corridor.jpg" crossorigin="anonymous">
        <img id="imgBathroom" src="assets/Bathroom.jpg" crossorigin="anonymous">
        <img id="imgBedroom" src="assets/Bedroom.jpg" crossorigin="anonymous">
        
        <!-- صور الهوت سبوت -->
        <img id="linkImg" src="assets/link.png" crossorigin="anonymous">
        <img id="link1Img" src="assets/link1.png" crossorigin="anonymous">
        <img id="link2Img" src="assets/link2.png" crossorigin="anonymous">
      </a-assets>
    </a-scene>

    <script>
      // تعريف المشاهد والهوت سبوت
      const scenes = {
        Living_Room: {
          src: '#imgLiving',
          name: 'غرفة المعيشة',
          hotspots: [
            { target: 'Kitchen',   position: '-3 1.6 4',   img: '#link2Img', size: 0.6 },
            { target: 'Reception', position: '-3 1.6 -1.7', img: '#linkImg',  size: 0.6 },
            { target: 'Corridor',  position: '3 1.6 3',    img: '#link1Img', size: 0.6 }
          ]
        },
        Kitchen: {
          src: '#imgKitchen',
          name: 'المطبخ',
          hotspots: [ { target: 'Living_Room', position: '4 1.6 -7', img: '#link2Img', size: 0.8 } ]
        },
        Reception: {
          src: '#imgReception',
          name: 'صالة الاستقبال',
          hotspots: [ { target: 'Living_Room', position: '5 1.6 -1', img: '#linkImg', size: 0.6 } ]
        },
        Corridor: {
          src: '#imgCorridor',
          name: 'الممر',
          hotspots: [
            { target: 'Bathroom',   position: '3 1.6 -0.5',  img: '#link2Img', size: 0.6 },
            { target: 'Bedroom',    position: '-0.2 1.6 -3.5', img: '#link2Img', size: 0.6 },
            { target: 'Living_Room', position: '1 1.6 3',     img: '#link2Img', size: 0.6 }
          ]
        },
        Bathroom: {
          src: '#imgBathroom',
          name: 'الحمام',
          hotspots: [ { target: 'Corridor', position: '-1 1.6 4', img: '#link1Img', size: 0.6 } ]
        },
        Bedroom: {
          src: '#imgBedroom',
          name: 'غرفة النوم',
          hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: '#link1Img', size: 0.6 } ]
        }
      };

      // حالة التطبيق
      const appState = {
        currentScene: 'Living_Room',
        isLoading: false,
        glowTextures: {}, // تخزين نسيج التوهج لتجنب إنشاء متكرر
        sceneOrder: ['Living_Room', 'Kitchen', 'Reception', 'Corridor', 'Bathroom', 'Bedroom']
      };

      // الحصول على الفهرس الحالي للمشهد
      function getCurrentSceneIndex() {
        return appState.sceneOrder.indexOf(appState.currentScene);
      }

      // الانتقال إلى المشهد التالي
      function goToNextScene() {
        const currentIndex = getCurrentSceneIndex();
        const nextIndex = (currentIndex + 1) % appState.sceneOrder.length;
        changeScene(appState.sceneOrder[nextIndex]);
      }

      // الانتقال إلى المشهد السابق
      function goToPrevScene() {
        const currentIndex = getCurrentSceneIndex();
        const prevIndex = (currentIndex - 1 + appState.sceneOrder.length) % appState.sceneOrder.length;
        changeScene(appState.sceneOrder[prevIndex]);
      }

      // رسم توهج ديناميكي مع التخزين
      function makeGlowDataURL(size = 512, colorCenter = '255,240,200', colorMid = '0,128,255') {
        const key = `${size}-${colorCenter}-${colorMid}`;
        
        // إذا كان النسيج موجود مسبقاً، إرجاعه
        if (appState.glowTextures[key]) {
          return appState.glowTextures[key];
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
        grad.addColorStop(0, `rgba(${colorCenter}, 0.95)`);
        grad.addColorStop(0.25, `rgba(${colorMid}, 0.7)`);
        grad.addColorStop(0.5, `rgba(${colorMid}, 0.4)`);
        grad.addColorStop(1, `rgba(${colorMid}, 0)`);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, size, size);
        
        const dataURL = canvas.toDataURL();
        appState.glowTextures[key] = dataURL; // تخزين النسيج
        return dataURL;
      }

      // إنشاء هوت سبوتات المشهد
      function createHotspots(sceneName) {
        const hotspotContainer = document.querySelector('#hotspotContainer');
        hotspotContainer.innerHTML = '';
        const scene = scenes[sceneName] || { hotspots: [] };

        scene.hotspots.forEach((hs, idx) => {
          // توليد صورة التوهج
          const dataURL = makeGlowDataURL(512);
          const glowId = `glow-${sceneName}-${idx}`;
          
          // إضافة صورة التوهج إلى assets إذا لم تكن موجودة
          if (!document.querySelector(`#${glowId}`)) {
            const glowImg = document.createElement('img');
            glowImg.setAttribute('id', glowId);
            glowImg.setAttribute('src', dataURL);
            document.querySelector('a-assets').appendChild(glowImg);
          }

          // الهوت سبوت (Icon)
          const el = document.createElement('a-plane');
          el.setAttribute('class', 'hotspot');
          el.setAttribute('position', hs.position);
          el.setAttribute('width', hs.size || 0.6);
          el.setAttribute('height', hs.size || 0.6);
          el.setAttribute('material', `src: ${hs.img}; transparent: true; shader: flat; opacity: 1`);
          el.setAttribute('look-at', '#cameraRig');

          // تأثير الظهور
          el.setAttribute('scale', '0 0 0');
          el.setAttribute('animation__popin', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');
          el.addEventListener('animationcomplete__popin', () => {
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
          });

          // التوهج
          const glow = document.createElement('a-plane');
          glow.setAttribute('position', hs.position);
          const glowScale = (hs.size || 0.6) * 1.2;
          glow.setAttribute('width', glowScale);
          glow.setAttribute('height', glowScale);
          glow.setAttribute('look-at', '#cameraRig');
          glow.setAttribute('material', `src: #${glowId}; transparent: true; shader: flat; depthTest: false; opacity: 0`);
          glow.setAttribute('visible', 'false');

          // اللافتة
          const label = document.createElement('a-text');
          label.setAttribute('value', scenes[hs.target].name);
          label.setAttribute('align', 'center');
          label.setAttribute('color', '#FFFFFF');
          label.setAttribute('width', 4);
          label.setAttribute('look-at', '#cameraRig');
          const pos = hs.position.split(' ');
          label.setAttribute('position', `${pos[0]} ${parseFloat(pos[1]) + 0.6} ${pos[2]}`);
          label.setAttribute('scale', '0 0 0');
          label.setAttribute('visible', 'true');

          // تفاعلات الماوس
          el.addEventListener('mouseenter', () => {
            playSound('clickSound');
            el.removeAttribute('animation__pulse');
            el.setAttribute('animation__hover', 'property: scale; to: 1.5 1.5 1.5; dur: 180; easing: easeOutQuad');
            label.removeAttribute('animation__scalefadeout');
            label.setAttribute('animation__scalefadein', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            glow.setAttribute('visible', 'true');
            glow.removeAttribute('animation__fadeout');
            glow.setAttribute('animation__fadein', 'property: material.opacity; to: 0.85; dur: 200; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscaleback');
            glow.setAttribute('animation__glowscale', 'property: scale; to: 1.25 1.25 1.25; dur: 200; easing: easeOutQuad');
          });

          el.addEventListener('mouseleave', () => {
            el.removeAttribute('animation__hover');
            el.setAttribute('scale', '1 1 1');
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
            label.removeAttribute('animation__scalefadein');
            label.setAttribute('animation__scalefadeout', 'property: scale; to: 0 0 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__fadein');
            glow.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscale');
            glow.setAttribute('animation__glowscaleback', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            setTimeout(() => { try { glow.setAttribute('visible', 'false'); } catch(e){} }, 320);
          });

          el.addEventListener('click', () => { changeScene(hs.target); });

          // ترتيب الإضافة: التوهج ثم الأيقونة ثم اللافتة
          hotspotContainer.appendChild(glow);
          hotspotContainer.appendChild(el);
          hotspotContainer.appendChild(label);
        });
      }

      // تشغيل الصوت
      function playSound(soundId, volume = 0.7) {
        const audio = document.querySelector(`#${soundId}`);
        if (audio) {
          try {
            audio.volume = volume;
            audio.currentTime = 0;
            audio.play().catch(e => console.log("لم يتم تشغيل الصوت تلقائياً:", e));
          } catch (e) {
            console.log("خطأ في تشغيل الصوت:", e);
          }
        }
      }

      // ====== RAF-based crossfade ======
      let currentFadeRAF = null;

      // الوصول المباشر لمادة السماء لرفع الأداء
      function setSkyOpacity(skyEl, value) {
        try {
          const mesh = skyEl.getObject3D && skyEl.getObject3D('mesh');
          if (mesh && mesh.material) {
            mesh.material.transparent = true;
            mesh.material.opacity = value;
            mesh.material.needsUpdate = true;
            return;
          }
        } catch (e) {}
        skyEl.setAttribute('material', `shader: flat; transparent: true; opacity: ${value}`);
      }

      // تغيير المشهد
      function changeScene(sceneName, duration = 700) {
        if (appState.isLoading || appState.currentScene === sceneName) return;
        
        appState.isLoading = true;
        const transitionOverlay = document.querySelector('#transitionOverlay');
        const nextSceneNameEl = document.querySelector('#nextSceneName');
        
        // عرض شاشة التحميل
        nextSceneNameEl.setAttribute('value', scenes[sceneName].name);
        transitionOverlay.classList.add('visible');
        
        const skyFront = document.querySelector('#skyFront');
        const skyBack  = document.querySelector('#skyBack');
        const hotspotContainer = document.querySelector('#hotspotContainer');

        // إلغاء أي انتقال سابق
        if (currentFadeRAF) {
          cancelAnimationFrame(currentFadeRAF);
          currentFadeRAF = null;
        }

        // إخفاء الهوت سبوتات القديمة فوراً
        Array.from(hotspotContainer.children).forEach(el => {
          try {
            el.setAttribute('visible', 'false');
            el.removeAttribute('animation__pulse');
            el.removeAttribute('animation__hover');
            el.removeAttribute('animation__fadein');
            el.removeAttribute('animation__glowscale');
            el.removeAttribute('animation__scalefadein');
            el.removeAttribute('animation__popin');
          } catch(e){}
        });

        // تحضير صورة المشهد الجديد على skyBack
        skyBack.setAttribute('src', scenes[sceneName].src);
        setSkyOpacity(skyBack, 0);

        // تشغيل صوت الانتقال
        playSound('transitionSound');

        // بدء الانتقال
        const start = performance.now();
        const dur = Math.max(50, duration);
        
        function step(now) {
          const t = Math.min(1, (now - start) / dur);
          const ease = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t; // easeInOut
          setSkyOpacity(skyBack, ease);
          setSkyOpacity(skyFront, 1 - ease);

          if (t < 1) {
            currentFadeRAF = requestAnimationFrame(step);
          } else {
            currentFadeRAF = null;
            // تثبيت المشهد الجديد
            skyFront.setAttribute('src', scenes[sceneName].src);
            setSkyOpacity(skyFront, 1);
            setSkyOpacity(skyBack, 0);
            try { skyBack.removeAttribute('src'); } catch(e){}

            // تحديث HUD
            document.querySelector('#sceneLabel').setAttribute('value', scenes[sceneName].name);
            
            // إنشاء هوت سبوتات المشهد الجديد
            createHotspots(sceneName);
            
            // تحديث الحالة وإخفاء شاشة التحميل
            appState.currentScene = sceneName;
            appState.isLoading = false;
            setTimeout(() => {
              transitionOverlay.classList.remove('visible');
            }, 300);
          }
        }
        currentFadeRAF = requestAnimationFrame(step);
      }

      // ====== شاشة الترحيب + التحميل ======
      const assets = document.querySelector('a-assets');
      const progressBar = document.getElementById('progressBar');
      const loadingStatus = document.getElementById('loadingStatus');
      const startBtn = document.getElementById('startBtn');
      const welcomeScreen = document.getElementById('welcomeScreen');
      const prevBtn = document.getElementById('prevScene');
      const nextBtn = document.getElementById('nextScene');

      // متابعة التقدم في التحميل
      assets.addEventListener('progress', (e) => {
        const loaded = e.detail && e.detail.loadedBytes ? e.detail.loadedBytes : 0;
        const total  = e.detail && e.detail.totalBytes  ? e.detail.totalBytes  : 0;
        const percent = total > 0 ? Math.floor((loaded/total)*100) : 0;
        progressBar.style.width = percent + '%';
        loadingStatus.textContent = `جاري التحميل... ${percent}%`;
      });

      // عند اكتمال التحميل
      assets.addEventListener('loaded', () => {
        progressBar.style.width = '100%';
        loadingStatus.textContent = 'اكتمل التحميل!';
        startBtn.style.display = 'block';
        
        // تشغيل الصوت الخلفي
        setTimeout(() => {
          playSound('backgroundSound', 0.3);
        }, 500);
      });

      // بدء الجولة
      startBtn.addEventListener('click', () => {
        welcomeScreen.classList.add('hidden');
        // بدء المشهد الأول
        changeScene('Living_Room', 800);
      });

      // إضافة مستمعي الأحداث لأزرار التحكم
      prevBtn.addEventListener('click', goToPrevScene);
      nextBtn.addEventListener('click', goToNextScene);

      // إضافة اختصارات لوحة المفاتيح
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') goToNextScene();
        if (e.key === 'ArrowLeft') goToPrevScene();
      });

      // تحسين الأداء عند تبديل علامة التبويب
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // إيقاف الصوت عند إخفاء الصفحة
          const sounds = document.querySelectorAll('audio');
          sounds.forEach(sound => sound.pause());
        } else {
          // إعادة تشغيل الصوت الخلفي عند العودة
          playSound('backgroundSound', 0.3);
        }
      });
    </script>
  </body>
</html>
