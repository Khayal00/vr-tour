<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Tour with Welcome Screen - Reliable Smooth Transition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }

      /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
      #welcomeScreen {
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: linear-gradient(135deg,#1a1a1a,#000000);
        display:flex; flex-direction:column;
        align-items:center; justify-content:center;
        color:white; z-index:9999;
      }
      #welcomeScreen h1 {
        font-size: 2.5em;
        margin-bottom: 20px;
        text-shadow: 0 0 8px rgba(255,255,255,0.6);
      }
      #instructions {
        font-size: 1em;
        margin-bottom: 30px;
        opacity: 0.85;
      }
      .progress-container {
        width: 60%;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        overflow: hidden;
        height: 20px;
        margin-bottom: 25px;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transition: width 0.3s;
      }
      #startBtn {
        padding: 12px 28px;
        border: none;
        border-radius: 30px;
        background: #4facfe;
        color: white;
        font-size: 1.1em;
        cursor: pointer;
        display:none;
      }
      #startBtn:hover { background: #00f2fe; }
    </style>
  </head>
  <body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
    <div id="welcomeScreen">
      <h1>âœ¨ VR Tour âœ¨</h1>
      <div id="instructions">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ù„Ù†Ø¸Ø± Ø­ÙˆÙ„Ùƒ</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <button id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
    </div>

    <!-- Ø§Ù„Ù…Ø´Ù‡Ø¯ -->
    <a-scene>
      <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø´Ø± (Ù…Ø±Ø§Ø¹Ø§Ø© Meta Quest controllers Ùˆ gaze) -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera look-controls>
          <a-cursor
            id="cursor"
            fuse="false"
            raycaster="objects: .hotspot"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: white; shader: flat">
          </a-cursor>
        </a-camera>

        <!-- HUD -->
        <a-text id="sceneLabel" value="Living Room" position="-1.2 0.8 -1"
          align="center" color="#FFFFFF" width="1"></a-text>

        <a-entity id="hudPlane" position="-1.2 0.8 -1">
          <a-plane width="0.3" height="0.1"
            material="color: #000000; opacity: 0.5; side: double; transparent: true">
          </a-plane>
        </a-entity>
      </a-entity>

      <!-- Ø³Ù…Ø§Ø¡Ø§Ù† Ù„Ù„Ù€ crossfade -->
      <a-sky id="skyFront" rotation="0 -90 0" visible="true"
             material="shader: flat; transparent: true; opacity: 1" src="#imgLiving"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0" visible="true"
             material="shader: flat; transparent: true; opacity: 0"></a-sky>

      <a-entity id="hotspotContainer"></a-entity>

      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3"></audio>
        <!-- ØµÙˆØ± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ -->
        <img id="imgLiving" src="assets/Living_Room.jpg">
        <img id="imgKitchen" src="assets/Kitchen.jpg">
        <img id="imgReception" src="assets/Reception.jpg">
        <img id="imgCorridor" src="assets/Corridor.jpg">
        <img id="imgBathroom" src="assets/Bathroom.jpg">
        <img id="imgBedroom" src="assets/Bedroom.jpg">
      </a-assets>
    </a-scene>

    <script>
      // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ ÙˆØ§Ù„Ù‡ÙˆØª Ø³Ø¨ÙˆØª
      const scenes = {
        Living_Room: {
          src: '#imgLiving',
          hotspots: [
            { target: 'Kitchen',   position: '-3 1.6 4',   img: 'assets/link2.png', size: 0.6 },
            { target: 'Reception', position: '-3 1.6 -1.7', img: 'assets/link.png',  size: 0.6 },
            { target: 'Corridor',  position: '3 1.6 3',    img: 'assets/link1.png', size: 0.6 }
          ]
        },
        Kitchen:    { src: '#imgKitchen',   hotspots: [ { target: 'Living_Room', position: '4 1.6 -7', img: 'assets/link2.png', size: 0.8 } ] },
        Reception:  { src: '#imgReception', hotspots: [ { target: 'Living_Room', position: '5 1.6 -1',  img: 'assets/link.png',  size: 0.6 } ] },
        Corridor: {
          src: '#imgCorridor',
          hotspots: [
            { target: 'Bathroom',   position: '3 1.6 -0.5',  img: 'assets/link2.png', size: 0.6 },
            { target: 'Bedroom',    position: '-0.2 1.6 -3.5',img: 'assets/link2.png', size: 0.6 },
            { target: 'Living_Room',position: '1 1.6 3',     img: 'assets/link2.png', size: 0.6 }
          ]
        },
        Bathroom:   { src: '#imgBathroom',  hotspots: [ { target: 'Corridor', position: '-1 1.6 4', img: 'assets/link1.png', size: 0.6 } ] },
        Bedroom:    { src: '#imgBedroom',   hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.6 } ] }
      };

      // Ø±Ø³Ù… ØªÙˆÙ‡Ø¬ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
      function makeGlowDataURL(size = 512, colorCenter = '255,240,200', colorMid = '0,128,255') {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = size;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
        grad.addColorStop(0, `rgba(${colorCenter}, 0.95)`);
        grad.addColorStop(0.25, `rgba(${colorMid}, 0.7)`);
        grad.addColorStop(0.5, `rgba(${colorMid}, 0.4)`);
        grad.addColorStop(1, `rgba(${colorMid}, 0)`);
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,size,size);
        return canvas.toDataURL();
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙˆØª Ø³Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯
      function createHotspots(sceneName) {
        const hotspotContainer = document.querySelector('#hotspotContainer');
        hotspotContainer.innerHTML = '';
        const scene = scenes[sceneName] || { hotspots: [] };

        scene.hotspots.forEach((hs, idx) => {
          // ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ø§Ù„ØªÙˆÙ‡Ø¬ Ø¯Ø§Ø®Ù„ a-assets
          const glowId = `glow-img-${sceneName}-${idx}-${Date.now()}`;
          const dataURL = makeGlowDataURL(512);
          const glowImg = document.createElement('img');
          glowImg.setAttribute('id', glowId);
          glowImg.setAttribute('src', dataURL);
          document.querySelector('a-assets').appendChild(glowImg);

          // Ø§Ù„Ù‡ÙˆØª Ø³Ø¨ÙˆØª (Icon)
          const el = document.createElement('a-plane');
          el.setAttribute('class', 'hotspot');
          el.setAttribute('position', hs.position);
          el.setAttribute('width', hs.size || 0.6);
          el.setAttribute('height', hs.size || 0.6);
          el.setAttribute('material', `src: url(${hs.img}); transparent: true; shader: flat; opacity: 1`);
          el.setAttribute('look-at', '#cameraRig');

          // ğŸ‘‡ ÙŠØ¨Ø¯Ø£ ØµØºÙŠØ±Ù‹Ø§ Ø«Ù… ÙŠÙƒØ¨Ø± (Pop-in)
          el.setAttribute('scale', '0 0 0');
          el.setAttribute('animation__popin', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');
          el.addEventListener('animationcomplete__popin', () => {
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
          });

          // Ø§Ù„ØªÙˆÙ‡Ø¬
          const glow = document.createElement('a-plane');
          glow.setAttribute('position', hs.position);
          const glowScale = (hs.size || 0.6) * 1.2;
          glow.setAttribute('width', glowScale);
          glow.setAttribute('height', glowScale);
          glow.setAttribute('look-at', '#cameraRig');
          glow.setAttribute('material', `src: #${glowId}; transparent: true; shader: flat; depthTest: false; opacity: 0`);
          glow.setAttribute('visible', 'false');

          // Ø§Ù„Ù„Ø§Ø¨Ù„
          const label = document.createElement('a-text');
          label.setAttribute('value', hs.target.replace('_', ' '));
          label.setAttribute('align', 'center');
          label.setAttribute('color', '#FFFFFF');
          label.setAttribute('width', 4);
          label.setAttribute('look-at', '#cameraRig');
          const pos = hs.position.split(' ');
          label.setAttribute('position', `${pos[0]} ${parseFloat(pos[1]) + 0.6} ${pos[2]}`);
          label.setAttribute('scale', '0 0 0');
          label.setAttribute('visible', 'true');

          // ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù…Ø§ÙˆØ³
          el.addEventListener('mouseenter', () => {
            el.removeAttribute('animation__pulse');
            el.setAttribute('animation__hover', 'property: scale; to: 1.5 1.5 1.5; dur: 180; easing: easeOutQuad');
            label.removeAttribute('animation__scalefadeout');
            label.setAttribute('animation__scalefadein', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            glow.setAttribute('visible', 'true');
            glow.removeAttribute('animation__fadeout');
            glow.setAttribute('animation__fadein', 'property: material.opacity; to: 0.85; dur: 200; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscaleback');
            glow.setAttribute('animation__glowscale', 'property: scale; to: 1.25 1.25 1.25; dur: 200; easing: easeOutQuad');
          });

          el.addEventListener('mouseleave', () => {
            el.removeAttribute('animation__hover');
            el.setAttribute('scale', '1 1 1');
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
            label.removeAttribute('animation__scalefadein');
            label.setAttribute('animation__scalefadeout', 'property: scale; to: 0 0 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__fadein');
            glow.setAttribute('animation__fadeout', 'property: material.opacity; to: 0; dur: 300; easing: easeOutQuad');
            glow.removeAttribute('animation__glowscale');
            glow.setAttribute('animation__glowscaleback', 'property: scale; to: 1 1 1; dur: 300; easing: easeOutQuad');
            setTimeout(() => { try { glow.setAttribute('visible', 'false'); } catch(e){} }, 320);
          });

          el.addEventListener('click', () => { changeScene(hs.target); });

          // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…: Ø§Ù„ØªÙˆÙ‡Ø¬ Ø«Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø«Ù… Ø§Ù„Ù„Ø§Ø¨Ù„
          const container = document.querySelector('#hotspotContainer');
          container.appendChild(glow);
          container.appendChild(el);
          container.appendChild(label);
        });
      }

      // ====== RAF-based crossfade ======
      let currentFadeRAF = null;

      // Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø¡ Ù„Ø±ÙØ¹ Ø§Ù„Ø£Ø¯Ø§Ø¡
      function setSkyOpacity(skyEl, value) {
        try {
          const mesh = skyEl.getObject3D && skyEl.getObject3D('mesh');
          if (mesh && mesh.material) {
            mesh.material.transparent = true;
            mesh.material.opacity = value;
            mesh.material.needsUpdate = true;
            return;
          }
        } catch (e) {}
        skyEl.setAttribute('material', `shader: flat; transparent: true; opacity: ${value}`);
      }

      // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ù‡Ø¯ + Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‡ÙˆØª Ø³Ø¨ÙˆØªØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙˆØ±Ù‹Ø§
      function changeScene(sceneName, duration = 700) {
        const skyFront = document.querySelector('#skyFront');
        const skyBack  = document.querySelector('#skyBack');
        const hotspotContainer = document.querySelector('#hotspotContainer');
        const audio = document.querySelector('#transitionSound');

        // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø§Ø¨Ù‚
        if (currentFadeRAF) { cancelAnimationFrame(currentFadeRAF); currentFadeRAF = null; }

        // ğŸ‘‡ Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù‡ÙˆØª Ø³Ø¨ÙˆØªØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙˆØ±Ù‹Ø§ Ø­ØªÙ‰ Ù„Ø§ ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ
        Array.from(hotspotContainer.children).forEach(el => {
          try {
            el.setAttribute('visible', 'false');
            el.removeAttribute('animation__pulse');
            el.removeAttribute('animation__hover');
            el.removeAttribute('animation__fadein');
            el.removeAttribute('animation__glowscale');
            el.removeAttribute('animation__scalefadein');
            el.removeAttribute('animation__popin');
          } catch(e){}
        });

        // Ø­Ø¶Ù‘Ø± ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ skyBack
        skyBack.setAttribute('src', scenes[sceneName].src);
        setSkyOpacity(skyBack, 0);

        // Ø´ØºÙ‘Ù„ ØµÙˆØª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try { audio.pause(); audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){}

        // Ø§Ø¨Ø¯Ø£ Ø­Ù„Ù‚Ø© Ø§Ù„Ù€ RAF
        const start = performance.now();
        const dur = Math.max(50, duration);
        function step(now) {
          const t = Math.min(1, (now - start) / dur);
          const ease = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t; // easeInOut ØªÙ‚Ø±ÙŠØ¨ÙŠ
          setSkyOpacity(skyBack, ease);      // 0 â†’ 1
          setSkyOpacity(skyFront, 1 - ease); // 1 â†’ 0

          if (t < 1) {
            currentFadeRAF = requestAnimationFrame(step);
          } else {
            currentFadeRAF = null;
            // Ø«Ø¨Ù‘Øª Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù…
            skyFront.setAttribute('src', scenes[sceneName].src);
            setSkyOpacity(skyFront, 1);
            setSkyOpacity(skyBack, 0);
            // âŒ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: Ù„Ø§ Ù†Ø­Ø°Ù src Ù…Ù† skyBack Ù„Ø£Ù† Ù‡Ø°Ø§ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Meta Quest
            // try { skyBack.removeAttribute('src'); } catch(e){}

            // Ø­Ø¯Ø« Ø§Ù„Ù€ HUD
            document.querySelector('#sceneLabel').setAttribute('value', sceneName.replace('_', ' '));

            // Ø£Ù†Ø´Ø¦ Ù‡ÙˆØª Ø³Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            createHotspots(sceneName);
          }
        }
        currentFadeRAF = requestAnimationFrame(step);
      }

      // ====== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ + Ø§Ù„ØªØ­Ù…ÙŠÙ„ ======
      const assets = document.querySelector('a-assets');
      const progressBar = document.getElementById('progressBar');
      const startBtn = document.getElementById('startBtn');
      const welcomeScreen = document.getElementById('welcomeScreen');

      // Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª progressBytesØŒ Ù‡Ø°Ø§ ÙØ§Ù„Ø¨Ø§Ùƒ Ø¨Ø³ÙŠØ·
      assets.addEventListener('progress', (e) => {
        const loaded = e.detail && e.detail.loadedBytes ? e.detail.loadedBytes : 0;
        const total  = e.detail && e.detail.totalBytes  ? e.detail.totalBytes  : 0;
        const percent = total > 0 ? Math.floor((loaded/total)*100) : 0;
        progressBar.style.width = percent + '%';
      });

      assets.addEventListener('loaded', () => {
        progressBar.style.width = '100%';
        startBtn.style.display = 'block';
      });

      startBtn.addEventListener('click', () => {
        welcomeScreen.style.transition = 'opacity 0.7s';
        welcomeScreen.style.opacity = '0';
        setTimeout(() => { welcomeScreen.style.display = 'none'; }, 700);
        // Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø£ÙˆÙ„
        changeScene('Living_Room', 800);
      });
    </script>
  </body>
</html>
