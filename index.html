<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>360° VR Tour — Professional (A-Frame)</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    html,body { height:100%; margin:0; font-family:Inter, system-ui, Arial; }
    .overlay {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; color:#fff; z-index:9999; flex-direction:column;
      transition:opacity .6s ease, visibility .6s; 
    }
    .overlay.hidden { opacity:0; visibility:hidden; }
    .loader { width:60%; max-width:720px; text-align:center }
    .progress { height:10px; background:rgba(255,255,255,.12); border-radius:10px; overflow:hidden; margin:14px 0 }
    .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,0.14), rgba(255,255,255,0.28)); transition:width .25s ease }
    .start-btn { background:#1e88e5; border:none; padding:12px 22px; color:white; font-weight:600; border-radius:8px; cursor:pointer }
    .start-btn:disabled { opacity:.5; cursor:not-allowed }

    /* Thumbnail gallery */
    .thumbs { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; display:flex; gap:10px; z-index:1000 }
    .thumb { width:96px; height:56px; border-radius:6px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.45); cursor:pointer; border:2px solid rgba(255,255,255,.06); background:#222; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block }
    .thumb .label { position:absolute; bottom:4px; left:6px; font-size:12px; color:#fff; text-shadow:0 1px 4px rgba(0,0,0,.6) }

    /* In-scene HUD */
    .hud { position:fixed; left:18px; top:18px; z-index:900; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.6) }
    .hud .title { font-weight:700; font-size:18px }
    .hud .controls { margin-top:8px; display:flex; gap:8px }
    .btn { background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.06); padding:6px 10px; border-radius:8px; color:#fff; cursor:pointer }

    /* Tooltip (DOM fallback) */
    .tooltip { position:fixed; z-index:10000; pointer-events:none; padding:6px 10px; background:rgba(0,0,0,.7); color:#fff; border-radius:6px; font-size:14px; transform:translate(-50%,-140%); white-space:nowrap }

    @media (max-width:700px){ .thumb { width:76px; height:48px } }
  </style>
</head>
<body>

  <!-- Preload assets (replace these with your 6 panoramas and thumbnails inside /assets/) -->
  <a-scene embedded vr-mode-ui="enabled: true">
    <a-assets id="assets">
      <!-- Replace the src values with your images -->
      <img id="pano1" src="assets/Living_Room.jpg" crossorigin="anonymous">
      <img id="pano2" src="assets/Reception.jpg" crossorigin="anonymous">
      <img id="pano3" src="assets/pano3.jpg" crossorigin="anonymous">
      <img id="pano4" src="assets/pano4.jpg" crossorigin="anonymous">
      <img id="pano5" src="assets/pano5.jpg" crossorigin="anonymous">
      <img id="pano6" src="assets/pano6.jpg" crossorigin="anonymous">

      <!-- Thumbs for gallery (optional) -->
      <img id="thumb1" src="assets/thumb1.jpg">
      <img id="thumb2" src="assets/thumb2.jpg">
      <img id="thumb3" src="assets/thumb3.jpg">
      <img id="thumb4" src="assets/thumb4.jpg">
      <img id="thumb5" src="assets/thumb5.jpg">
      <img id="thumb6" src="assets/thumb6.jpg">

      <!-- Optional ambient audio per-scene -->
      <audio id="amb1" src="assets/amb1.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Main sky (we swap its texture on scene changes) -->
    <a-sphere id="sky" radius="500" theta-length="180" phi-length="360" scale="-1 1 1" material="src: #pano1; shader: flat; roughness:1"></a-sphere>

    <!-- Overlay plane used for smooth fade transitions (in front of camera) -->
    <a-entity id="fadePlane" geometry="primitive: plane; height: 2; width: 2" material="color: #000; opacity: 0" position="0 0 -1" visible="true" render-order="1"></a-entity>

    <!-- Camera rig with cursor (works for desktop + controllers + gaze) -->
    <a-entity id="cameraRig">
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable" position="0 0 -0.1" geometry="primitive: ring; radiusInner:0.01; radiusOuter:0.02" material="shader: flat; opacity: .9; transparent:true"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Example hotspots: customize position & target -->
    <!-- Hotspot is a clickable entity that enlarges on hover, shows tooltip, and navigates -->
    <a-entity id="hotspots">
      <!-- Hotspot 1 (goes to pano2) -->
      <a-entity class="hotspot clickable" hotspot="label: Living Room; target: pano2" position="1.2 1.2 -2">
        <a-sphere radius="0.12" segments-width="18" segments-height="12" material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 0.8; shader: standard; metalness:0.1; roughness:0.2"></a-sphere>
        <a-ring radius-inner="0.15" radius-outer="0.28" rotation="-90 0 0" material="shader: flat; opacity:0.45"></a-ring>
      </a-entity>

      <!-- Hotspot 2 (goes to pano3) -->
      <a-entity class="hotspot clickable" hotspot="label: Kitchen; target: pano3" position="-1.4 0.8 -1.6">
        <a-sphere radius="0.12" material="color:#fff; emissive:#fff; emissiveIntensity:0.9; roughness:0.25"></a-sphere>
        <a-ring radius-inner="0.15" radius-outer="0.28" rotation="-90 0 0" material="shader: flat; opacity:0.45"></a-ring>
      </a-entity>

      <!-- Add as many hotspots per scene as you need. You can add a `scene` attribute to limit visibility per scene -->
    </a-entity>

    <!-- Optional ambient-sound + per-scene audio control -->
    <a-entity id="soundPlayer" sound="src: #amb1; autoplay: false; loop: true; positional: false"></a-entity>

  </a-scene>

  <!-- UI overlay (start / loading) -->
  <div id="overlay" class="overlay">
    <div class="loader">
      <h2 style="margin:0 0 8px 0">تحميل الجولة — الرجاء الانتظار</h2>
      <div class="progress"><i id="bar"></i></div>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:6px;">
        <button id="startBtn" class="start-btn" disabled>ابدأ الجولة</button>
        <button id="muteBtn" class="btn">كتم صوت</button>
      </div>
      <p style="opacity:.7; margin-top:12px; font-size:13px">جاري تحميل الصور... ضع ملفاتك داخل مجلد <code>/assets/</code> (pano1..pano6 + thumb1..thumb6)</p>
    </div>
  </div>

  <!-- HUD and thumbnails -->
  <div class="hud">
    <div class="title" id="sceneTitle">Scene 1</div>
    <div class="controls">
      <button class="btn" id="prev">◀ Prev</button>
      <button class="btn" id="next">Next ▶</button>
      <button class="btn" id="autorotate">Auto-rotate</button>
    </div>
  </div>

  <div class="thumbs" id="thumbs">
    <div class="thumb" data-target="pano1"><img src="assets/thumb1.jpg" alt="1"></div>
    <div class="thumb" data-target="pano2"><img src="assets/thumb2.jpg" alt="2"></div>
    <div class="thumb" data-target="pano3"><img src="assets/thumb3.jpg" alt="3"></div>
    <div class="thumb" data-target="pano4"><img src="assets/thumb4.jpg" alt="4"></div>
    <div class="thumb" data-target="pano5"><img src="assets/thumb5.jpg" alt="5"></div>
    <div class="thumb" data-target="pano6"><img src="assets/thumb6.jpg" alt="6"></div>
  </div>

  <!-- Floating tooltip (DOM) -->
  <div id="tooltip" class="tooltip" style="display:none"></div>

  <script>
    (function(){
      const sceneList = [
        { id: 'pano1', title: 'Scene 1' },
        { id: 'pano2', title: 'Scene 2' },
        { id: 'pano3', title: 'Scene 3' },
        { id: 'pano4', title: 'Scene 4' },
        { id: 'pano5', title: 'Scene 5' },
        { id: 'pano6', title: 'Scene 6' }
      ];

      const bar = document.getElementById('bar');
      const startBtn = document.getElementById('startBtn');
      const overlay = document.getElementById('overlay');
      const muteBtn = document.getElementById('muteBtn');
      const sceneTitle = document.getElementById('sceneTitle');
      const thumbs = document.getElementById('thumbs');
      const tooltip = document.getElementById('tooltip');

      const sky = document.getElementById('sky');
      const fadePlane = document.getElementById('fadePlane');
      const soundPlayer = document.getElementById('soundPlayer');

      let current = 0;
      let autoRotate = false;

      // Gather assets (images + audio/video) and robust loader with fallback
      const imageEls = Array.from(document.querySelectorAll('#assets img'));
      const mediaEls = Array.from(document.querySelectorAll('#assets audio, #assets video'));
      const assetsToLoad = imageEls.concat(mediaEls);
      let loadedCount = 0;
      let totalCount = assetsToLoad.length;
      const missing = [];

      // update progress bar helper
      function updateBar(){
        const percent = totalCount === 0 ? 100 : Math.round((loadedCount / totalCount) * 100);
        bar.style.width = percent + '%';
        if(loadedCount >= totalCount){
          // all assets processed (loaded or errored)
          startBtn.disabled = false;
          document.querySelector('#overlay h2').innerText = 'جاهز — اضغط ابدأ';
          clearTimeout(fallbackTimer);
        }
      }

      if(totalCount === 0){
        // no assets found (allow start)
        loadedCount = 0; updateBar();
      } else {
        assetsToLoad.forEach(el => {
          if(el.tagName.toLowerCase() === 'img'){
            if(el.complete && el.naturalWidth > 0){ loadedCount++; updateBar(); }
            else{
              el.addEventListener('load', ()=>{ loadedCount++; updateBar(); });
              el.addEventListener('error', ()=>{ missing.push(el.getAttribute('src') || el.id); loadedCount++; updateBar(); });
            }
          } else {
            // audio/video
            if(el.readyState >= 3){ loadedCount++; updateBar(); }
            else{
              el.addEventListener('canplaythrough', ()=>{ loadedCount++; updateBar(); });
              el.addEventListener('error', ()=>{ missing.push(el.getAttribute('src') || el.id); loadedCount++; updateBar(); });
            }
          }
        });
      }

      // fallback: after 5s allow start and warn about missing assets
      const fallbackTimer = setTimeout(()=>{
        if(startBtn.disabled){
          console.warn('Loader fallback: بعض الملفات لم تُحمل أو استغرق تحميلها وقتاً طويلاً', missing);
          document.querySelector('#overlay h2').innerText = 'جاهز (تحذير: بعض الملفات لم تُحمل) — اضغط ابدأ';
          startBtn.disabled = false;
          bar.style.width = '100%';
        }
      }, 5000);

      // initial bar update
      updateBar();

      startBtn.addEventListener('click', ()=>{
        overlay.classList.add('hidden');
        // small start fade
        fadePlane.setAttribute('material', 'opacity', 1);
        setTimeout(()=> fadePlane.setAttribute('material', 'opacity', 0), 400);
        applyScene(current);
      });

      muteBtn.addEventListener('click', ()=>{
        const soundComp = soundPlayer.components.sound;
        if(!soundComp) return;
        soundComp.pause();
        muteBtn.style.display = 'none';
      });

      // thumbnail clicks
      thumbs.addEventListener('click', (e)=>{
        const t = e.target.closest('.thumb');
        if(!t) return;
        const target = t.getAttribute('data-target');
        const idx = sceneList.findIndex(s=>s.id===target);
        if(idx >= 0) goToScene(idx);
      });

      // prev/next
      document.getElementById('prev').addEventListener('click', ()=> goToScene((current-1+sceneList.length)%sceneList.length));
      document.getElementById('next').addEventListener('click', ()=> goToScene((current+1)%sceneList.length));
      document.getElementById('autorotate').addEventListener('click', ()=>{
        autoRotate = !autoRotate; document.getElementById('autorotate').innerText = autoRotate? 'Auto-rotate (On)' : 'Auto-rotate';
        const camera = document.getElementById('camera');
        if(autoRotate) camera.setAttribute('rotation', '0 0 0');
      });

      // Auto-rotate tick
      setInterval(()=>{
        if(!autoRotate) return; 
        const cam = document.getElementById('camera');
        let r = cam.getAttribute('rotation');
        cam.setAttribute('rotation', { x: r.x, y: r.y + 0.12, z: r.z });
      }, 30);

      // Transition helper
      function fadeTransition(newSrcId, title){
        // fade to black
        fadePlane.setAttribute('material', 'opacity', 0);
        fadePlane.object3D.visible = true;
        // animate opacity up
        animeOpacity(0, 1, 420, (v)=> fadePlane.setAttribute('material','opacity', v), ()=>{
          // swap texture
          sky.setAttribute('material', 'src', '#' + newSrcId);
          sceneTitle.innerText = title;
          // fade back
          animeOpacity(1, 0, 420, (v)=> fadePlane.setAttribute('material','opacity', v));
        });
      }

      // small animator for opacity
      function animeOpacity(from, to, dur, onFrame, onComplete){
        const start = performance.now();
        function tick(now){
          const t = Math.min(1, (now-start)/dur);
          const v = from + (to-from) * t;
          onFrame(v);
          if(t<1) requestAnimationFrame(tick); else onComplete && onComplete();
        }
        requestAnimationFrame(tick);
      }

      function goToScene(idx){
        if(idx === current) return;
        const s = sceneList[idx];
        fadeTransition(s.id, s.title);
        current = idx;
      }

      function applyScene(idx){
        const s = sceneList[idx];
        sky.setAttribute('material', 'src', '#' + s.id);
        sceneTitle.innerText = s.title;
      }

      // Hotspot component: hover grow, tooltip, click -> scene
      AFRAME.registerComponent('hotspot', {
        schema: { label: { type: 'string', default: '' }, target: { type: 'string', default: '' } },
        init: function(){
          const el = this.el;
          const data = this.data;

          // create text label above hotspot (3D)
          const label = document.createElement('a-entity');
          label.setAttribute('text', `value: ${data.label}; align: center; width: 2; color: #fff; baseline: bottom`);
          label.setAttribute('position', '0 0.28 0');
          label.setAttribute('visible', false);
          el.appendChild(label);

          el.addEventListener('mouseenter', (evt)=>{
            // scale up
            el.object3D.scale.set(1.6,1.6,1.6);
            label.setAttribute('visible', true);
            // DOM tooltip follow (optional)
            tooltip.style.display = 'block'; tooltip.innerText = data.label;
          });
          el.addEventListener('mouseleave', ()=>{
            el.object3D.scale.set(1,1,1);
            label.setAttribute('visible', false);
            tooltip.style.display = 'none';
          });
          el.addEventListener('click', ()=>{
            // find index of target
            const idx = sceneList.findIndex(s=>s.id === data.target);
            if(idx>=0) goToScene(idx);
          });

          // update tooltip position while looking
          el.sceneEl.canvas && el.sceneEl.addEventListener('mousemove', (ev)=>{
            // project 3D position to 2D
            try{
              const screenPos = this.worldToScreen(el.object3D, el.sceneEl);
              tooltip.style.left = screenPos.x + 'px';
              tooltip.style.top = screenPos.y + 'px';
            }catch(e){}
          });
        },
        worldToScreen(obj3d, sceneEl){
          const camera = sceneEl.camera;
          const vector = new THREE.Vector3();
          obj3d.getWorldPosition(vector);
          vector.project(camera);
          const widthHalf = 0.5 * sceneEl.canvas.width;
          const heightHalf = 0.5 * sceneEl.canvas.height;
          return { x: ( vector.x * widthHalf ) + widthHalf, y: -( vector.y * heightHalf ) + heightHalf };
        }
      });

      // wire up DOM tooltip hide on leave
      document.querySelector('a-scene').addEventListener('mouseleave', ()=> tooltip.style.display = 'none');

      // Keyboard shortcuts
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft') document.getElementById('prev').click();
        if(e.key === 'ArrowRight') document.getElementById('next').click();
        if(e.key === ' ') { e.preventDefault(); document.getElementById('startBtn').click(); }
      });

      // Start with first scene once assets are ready
      // (If user doesn't press Start, they can still click thumbs once loaded)
      // Ensure tooltip follows pointer for touch/mouse
      document.addEventListener('pointermove', (ev)=>{
        tooltip.style.left = ev.clientX + 'px';
        tooltip.style.top = ev.clientY + 'px';
      });

      // initial apply
      applyScene(current);

    })();
  </script>

</body>
</html>
