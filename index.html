<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Tour - Meta Quest Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      body { margin: 0; }
      .hotspot-label {
        color: white;
        background: rgba(0,0,0,0.5);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <a-scene>
      
      <!-- المشهدين (سماوات) -->
      <a-sky id="skyFront" rotation="0 -90 0"
             visible="true"
             material="shader: flat; transparent: true; opacity: 1"
             src="scene1.jpg"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0"
             visible="true"
             material="shader: flat; transparent: true; opacity: 0"></a-sky>

      <!-- الهوت سبوت container -->
      <a-entity id="hotspots"></a-entity>

      <!-- الكاميرا مع المؤشر -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera look-controls>
          <a-cursor
            id="cursor"
            fuse="false"
            raycaster="objects: .hotspot"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: white; shader: flat">
          </a-cursor>
        </a-camera>
      </a-entity>
    </a-scene>

    <script>
      const scenes = {
        scene1: {
          src: "scene1.jpg",
          hotspots: [
            {position: "2 1 -3", text: "Go to Scene 2", target: "scene2"}
          ]
        },
        scene2: {
          src: "scene2.jpg",
          hotspots: [
            {position: "-2 1 3", text: "Back to Scene 1", target: "scene1"}
          ]
        }
      };

      // ضبط الشفافية
      function setSkyOpacity(skyEl, opacity) {
        skyEl.setAttribute("material", "opacity", opacity);
      }

      // fadeIn
      function fadeInSky(skyEl, duration) {
        let opacity = 0;
        const step = 50 / duration;
        const interval = setInterval(() => {
          opacity += step;
          if (opacity >= 1) {
            opacity = 1;
            clearInterval(interval);
          }
          setSkyOpacity(skyEl, opacity);
        }, 50);
      }

      // fadeOut
      function fadeOutSky(skyEl, duration) {
        let opacity = 1;
        const step = 50 / duration;
        const interval = setInterval(() => {
          opacity -= step;
          if (opacity <= 0) {
            opacity = 0;
            clearInterval(interval);
          }
          setSkyOpacity(skyEl, opacity);
        }, 50);
      }

      // تحديث الهوت سبوت
      function updateHotspots(sceneName) {
        const hotspotContainer = document.getElementById("hotspots");
        hotspotContainer.innerHTML = "";
        scenes[sceneName].hotspots.forEach(hs => {
          const hotspot = document.createElement("a-entity");
          hotspot.setAttribute("geometry", "primitive: sphere; radius: 0.2");
          hotspot.setAttribute("material", "color: yellow; emissive: yellow; shader: flat");
          hotspot.setAttribute("class", "hotspot");
          hotspot.setAttribute("position", hs.position);
          hotspot.setAttribute("look-at", "#cameraRig");

          // النص
          const label = document.createElement("a-text");
          label.setAttribute("value", hs.text);
          label.setAttribute("align", "center");
          label.setAttribute("color", "white");
          label.setAttribute("position", "0 0.3 0");
          label.setAttribute("width", "2");
          hotspot.appendChild(label);

          // الضغط
          hotspot.addEventListener("click", () => {
            changeScene(hs.target);
          });

          hotspotContainer.appendChild(hotspot);
        });
      }

      // تغيير المشهد (مع Crossfade)
      function changeScene(sceneName) {
        const skyFront = document.querySelector("#skyFront");
        const skyBack = document.querySelector("#skyBack");

        // ضع المشهد الجديد في skyBack وخليه شفاف
        skyBack.setAttribute("src", scenes[sceneName].src);
        setSkyOpacity(skyBack, 0);

        // ابدأ الفيد إن للمشهد الجديد
        fadeInSky(skyBack, 2000);

        // اعمل فيد آوت للقديم
        fadeOutSky(skyFront, 2000);

        // بعد انتهاء الانتقال بدّل الأدوار
        setTimeout(() => {
          skyFront.setAttribute("src", scenes[sceneName].src);
          setSkyOpacity(skyFront, 1);
          setSkyOpacity(skyBack, 0);

          updateHotspots(sceneName);
        }, 2000);
      }

      // تحميل أول مشهد
      updateHotspots("scene1");
    </script>
  </body>
</html>
