<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>VR 360 Tour - A-Frame (Crossfade) - مدموج</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
   * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            overflow: hidden;
            background: #000;
            color: #fff;
            height: 100vh;
            width: 100vw;
            perspective: 1000px;
        }
        
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s ease;
        }
        
        #welcome-content {
            text-align: center;
            max-width: 800px;
            padding: 20px;
            transform: translateZ(50px);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateZ(50px); }
            50% { transform: translateY(-20px) translateZ(50px); }
            100% { transform: translateY(0) translateZ(50px); }
        }
        
        #welcome-screen h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 0 15px rgba(255,255,255,0.7);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #e60073, 0 0 40px #e60073; }
            to { text-shadow: 0 0 15px #fff, 0 0 25px #ff4da6, 0 0 35px #ff4da6, 0 0 45px #ff4da6; }
        }
        
        #welcome-screen p {
            font-size: 1.4rem;
            margin-bottom: 30px;
            line-height: 1.7;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        
        .btn {
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        }
        
        .btn:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255,255,255,0.3);
            transform: rotate(25deg);
            transition: all 0.6s;
        }
        
        .btn:hover:after {
            left: 120%;
        }
        
        #loading-container {
            width: 80%;
            max-width: 500px;
            height: 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            margin: 40px 0;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        #loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            border-radius: 15px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0,201,255,0.5);
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            padding: 12px;
            background: rgba(0,0,0,0.7);
            z-index: 10;
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        #controls {
            position: absolute;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(10deg);
        }
        
        #scene-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.6);
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1.3rem;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
        }
        
        .hotspot-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.1rem;
            white-space: nowrap;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 20;
            font-weight: bold;
        }
        
        .scene-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            z-index: 5;
            text-align: center;
            width: 100%;
            pointer-events: none;
            opacity: 1;
            transition: opacity 1s ease;
        }
        
        .scene-indicator h2 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255,255,255,0.7);
        }
        
        @media (max-width: 768px) {
            #welcome-screen h1 {
                font-size: 2.5rem;
            }
            
            #welcome-screen p {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 12px 30px;
                font-size: 1rem;
            }
            
            #scene-info {
                font-size: 1rem;
                padding: 10px 20px;
            }
            
            #controls {
                bottom: 70px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .scene-indicator h2 {
                font-size: 2.2rem;
            }
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00c9ff, #92fe9d);
            transition: width 0.5s ease;
        }
  </style>
</head>
<body>
  <div id="overlay">
    <div id="welcomeBox">
      <div id="title">مرحباً بكم في الجولة الافتراضية</div>
      <div id="subtitle">التجربة تعمل على نظارات VR (Meta Quest) والموبايل والكمبيوتر — مرّر المؤشر على النقاط لتعريف المكان، واضغط أو انظر للنقطة للانتقال.</div>

      <div id="progressBar"><div id="progressFill"></div></div>
      <div id="progressText" style="margin-top:8px;">تحميل الصور: <span id="percent">0%</span></div>

      <button id="startBtn" disabled>ابدأ الجولة</button>
      <div id="instructions" style="margin-top:8px;">
        تحكم: لمس / نقرة / المؤشر على الكمبيوتر — أو استخدم ذراع تحكم النظارة (laser).<br>
        يمكنك تعديل مواقع الهوتسبوت في الكود ضمن مصفوفة `hotspotsData`.
      </div>
    </div>
  </div>

  <a-scene background="color: #000" vr-mode-ui="enabled: true">
    <a-entity id="cameraRig">
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <a-entity id="gazeCursor"
          cursor="fuse: true; fuseTimeout: 1000"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: white; shader: flat; opacity:0.9;">
        </a-entity>
      </a-entity>

      <a-entity laser-controls="hand: right" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable" line="opacity: 0.75"></a-entity>
    </a-entity>

    <a-sky id="skyA" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:1"></a-sky>
    <a-sky id="skyB" radius="5000" position="0 0 0" material="shader: flat; transparent: true; side: double; opacity:0"></a-sky>

    <!-- HOTSPOTS ROOT: نتحكم في ظهوره لإخفاء العناصر أثناء التلاشي -->
    <a-entity id="hotspotsRoot" visible="true"></a-entity>

    <a-entity id="desktopCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable" visible="false"></a-entity>
  </a-scene>

<script>
  // ---------- CONFIG ----------
  const scenes = {
    "Reception": "assets/Reception.jpg",
    "Living_Room": "assets/Living_Room.jpg",
    "Kitchen": "assets/Kitchen.jpg",
    "Corridor": "assets/Corridor.jpg",
    "Bedroom": "assets/Bedroom.jpg",
    "Bathroom": "assets/Bathroom.jpg"
  };

  const hotspotsData = {
    "Reception": [
      { label: "الصالة", target: "Living_Room", lat: 0, lon: 60 }
    ],
    "Kitchen": [
      { label: "الصالة", target: "Living_Room", lat: 10, lon: -80 }
    ],
    "Corridor": [
      { label: "الصالة", target: "Living_Room", lat: 0, lon: 160 },
      { label: "غرفة النوم", target: "Bedroom", lat: 5, lon: -30 },
      { label: "الحمام", target: "Bathroom", lat: -5, lon: -60 }
    ],
    "Living_Room": [
      { label: "الاستقبال", target: "Reception", lat: 0, lon: -110 },
      { label: "المطبخ", target: "Kitchen", lat: 10, lon: 60 },
      { label: "الممر", target: "Corridor", lat: -5, lon: 150 }
    ],
    "Bedroom": [
      { label: "الممر", target: "Corridor", lat: 0, lon: 120 }
    ],
    "Bathroom": [
      { label: "الممر", target: "Corridor", lat: 0, lon: -140 }
    ]
  };

  const initialScene = "Reception";

  // ---------- PRELOADER ----------
  const overlay = document.getElementById('overlay');
  const progressFill = document.getElementById('progressFill');
  const percentText = document.getElementById('percent');
  const startBtn = document.getElementById('startBtn');

  const imageUrls = Object.values(scenes);
  let loadedCount = 0;
  function preloadImages(urls, onComplete, onProgress){
    urls.forEach(url => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => { loadedCount++; onProgress(loadedCount, urls.length); if(loadedCount===urls.length) onComplete(); };
      img.onerror = () => { console.warn('Failed to load', url); loadedCount++; onProgress(loadedCount, urls.length); if(loadedCount===urls.length) onComplete(); };
      img.src = url;
    });
  }

  preloadImages(imageUrls, () => {
    startBtn.disabled = false;
  }, (loaded,total) => {
    const pct = Math.round(loaded/total*100);
    progressFill.style.width = pct + "%";
    percentText.innerText = pct + "%";
  });

  startBtn.addEventListener('click', () => {
    overlay.style.display = 'none';
    enterScene(initialScene);
  });
  document.addEventListener('keydown', e => {
    if((e.key === 'Enter' || e.key === ' ') && !startBtn.disabled){
      overlay.style.display = 'none';
      enterScene(initialScene);
    }
  });

  // ---------- UTILS ----------
  function latLonToCartesian(latDeg, lonDeg, radius){
    const lat = latDeg * Math.PI/180;
    const lon = lonDeg * Math.PI/180;
    const x = radius * Math.cos(lat) * Math.sin(lon);
    const y = radius * Math.sin(lat);
    const z = radius * Math.cos(lat) * Math.cos(lon) * -1;
    return { x, y, z };
  }

  // ---------- HOTSPOTS ----------
  const sceneEl = document.querySelector('a-scene');
  const skyA = document.getElementById('skyA');
  const skyB = document.getElementById('skyB');
  let activeSky = skyA;
  let inactiveSky = skyB;
  const hotspotsRoot = document.getElementById('hotspotsRoot');

  function makeHotspot(h) {
    const hotspot = document.createElement('a-entity');
    hotspot.classList.add('clickable');
    hotspot.setAttribute('geometry', 'primitive: plane; height: 0.6; width: 0.6');
    hotspot.setAttribute('material', 'src: url(assets/hotspot.png); transparent: true; shader: flat; side: double');
    hotspot.setAttribute('look-at', '#camera');
    hotspot.setAttribute('shadow', 'receive: false;cast:false');
    hotspot.setAttribute('visible', true);

    // pulse animation (running)
    hotspot.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 900; easing: easeInOutSine; loop: true; to: 1.12 1.12 1.12; from: 0.95 0.95 0.95');

    // label background
    const labelBg = document.createElement('a-plane');
    labelBg.setAttribute('height', '0.28');
    labelBg.setAttribute('width', '1.4');
    labelBg.setAttribute('material', 'color: #000; opacity: 0.45; shader: flat;');
    labelBg.setAttribute('position', `0 0.62 0`);
    labelBg.setAttribute('visible', false);

    // text label (NO msdf)
    const label = document.createElement('a-entity');
    label.setAttribute('text',
      `value: ${h.label}; align: center; wrapCount: 20; width: 1.7; color: #FFFFFF;`
    );
    label.setAttribute('position', `0 0.62 0.02`); // in front of bg to avoid z-fighting
    label.setAttribute('visible', false);

    hotspot.addEventListener('mouseenter', () => {
      hotspot.setAttribute('animation__hover', 'property: scale; to: 1.45 1.45 1.45; dur: 180; easing: easeOutQuad');
      label.setAttribute('visible', true);
      labelBg.setAttribute('visible', true);
    });
    hotspot.addEventListener('mouseleave', () => {
      hotspot.setAttribute('animation__hover', 'property: scale; to: 1 1 1; dur: 150; easing: easeOutQuad');
      label.setAttribute('visible', false);
      labelBg.setAttribute('visible', false);
    });

    // click / controller
    const triggerNavigate = () => {
      const tgt = hotspot.getAttribute('data-target');
      if (tgt) {
        disableHotspots();
        // hide entire hotspots root immediately to avoid lingering visuals during crossfade
        hotspotsRoot.setAttribute('visible', 'false');
        fadeToScene(tgt);
      }
    };
    hotspot.addEventListener('click', triggerNavigate);
    hotspot.addEventListener('triggerdown', triggerNavigate);

    // append: bg first, then text (text slightly in front)
    hotspot.appendChild(labelBg);
    hotspot.appendChild(label);
    return hotspot;
  }

  function disableHotspots() {
    hotspotsRoot.querySelectorAll('.clickable').forEach(el => {
      el.classList.remove('clickable');
      el.classList.add('disabled');
    });
  }
  function enableHotspots() {
    hotspotsRoot.querySelectorAll('.disabled').forEach(el => {
      el.classList.remove('disabled');
      el.classList.add('clickable');
    });
  }

  function buildHotspotsFor(sceneName) {
    // reset any running pulse animations to avoid leftover scales
    hotspotsRoot.querySelectorAll('[animation__pulse]').forEach(el => {
      try {
        el.removeAttribute('animation__pulse');
        // reset scale (object3D exists once in scene)
        if (el.object3D) el.object3D.scale.set(1,1,1);
      } catch(e) { /* ignore */ }
    });

    // clear previous children
    while (hotspotsRoot.firstChild) hotspotsRoot.removeChild(hotspotsRoot.firstChild);

    const list = hotspotsData[sceneName] || [];
    list.forEach(h => {
      const pos = latLonToCartesian(h.lat || 0, h.lon || 0, 3.5);
      const ent = makeHotspot(h);
      ent.setAttribute('position', `${pos.x.toFixed(3)} ${pos.y.toFixed(3)} ${pos.z.toFixed(3)}`);
      ent.setAttribute('data-target', h.target);
      ent.setAttribute('look-at', '#camera');
      hotspotsRoot.appendChild(ent);
    });
  }

  // ---------- CROSSFADE ----------
  let isTransitioning = false;
  async function fadeToScene(targetName) {
    if (isTransitioning) return;
    if (!scenes[targetName]) {
      console.warn('Unknown scene target:', targetName);
      hotspotsRoot.setAttribute('visible', 'true');
      enableHotspots();
      return;
    }
    isTransitioning = true;
    const fadeDur = 700;

    // ensure hotspots hidden (in case caller didn't)
    hotspotsRoot.setAttribute('visible', 'false');

    // clean previous animations on skies
    inactiveSky.removeAttribute('animation__in');
    activeSky.removeAttribute('animation__out');

    // set new texture on inactive sky (opacity 0 to start)
    inactiveSky.setAttribute('material',
      `src: url(${scenes[targetName]}); shader: flat; transparent: true; side: double; opacity: 0`
    );

    // ensure active sky has consistent material
    activeSky.setAttribute('material', `shader: flat; transparent: true; side: double; opacity: 1`);

    // animate crossfade
    inactiveSky.setAttribute('animation__in',
      `property: material.opacity; to: 1; dur: ${fadeDur}; easing: easeInOutQuad`
    );
    activeSky.setAttribute('animation__out',
      `property: material.opacity; to: 0; dur: ${fadeDur}; easing: easeInOutQuad`
    );

    // wait for animation to finish
    await new Promise(resolve => setTimeout(resolve, fadeDur + 40));

    // finalize opacities and swap refs
    activeSky.setAttribute('material', 'opacity', 0);
    inactiveSky.setAttribute('material', 'opacity', 1);

    const tmp = activeSky;
    activeSky = inactiveSky;
    inactiveSky = tmp;

    // remove animation attrs to keep clean state
    activeSky.removeAttribute('animation__in');
    inactiveSky.removeAttribute('animation__out');

    // rebuild hotspots for the new scene
    buildHotspotsFor(targetName);

    // tiny delay so rebuild finishes then show and enable
    await new Promise(resolve => setTimeout(resolve, 90));
    hotspotsRoot.setAttribute('visible', 'true');
    enableHotspots();
    isTransitioning = false;
  }

  // ---------- ENTER SCENE ----------
  function enterScene(sceneName) {
    if (!scenes[sceneName]) {
      console.error('Initial scene not found:', sceneName);
      return;
    }
    // set active sky and opacities
    activeSky.setAttribute('material', `src: url(${scenes[sceneName]}); shader: flat; transparent: true; side: double; opacity: 1`);
    inactiveSky.setAttribute('material', `shader: flat; transparent: true; side: double; opacity: 0`);
    buildHotspotsFor(sceneName);

    const deskCursor = document.getElementById('desktopCursor');
    if (AFRAME.utils.device.isDesktop()) {
      deskCursor.setAttribute('visible', true);
    } else {
      deskCursor.setAttribute('visible', false);
    }
  }

  sceneEl.addEventListener('loaded', () => {
    activeSky.setAttribute('material', 'shader: flat; transparent: true; side: double;');
    inactiveSky.setAttribute('material', 'shader: flat; transparent: true; side: double;');
  });

  window.vrTour = { enterScene, fadeToScene, hotspotsData, scenes };

  if (overlay.style.display === 'none') enterScene(initialScene);
</script>
</body>
</html>
