<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Tour — Hotspots Visible + HUD + Smooth Crossfade + Cursor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <style>
    body { margin: 0; }
    .hotspot { cursor: pointer; }
    .hotspot.disabled { pointer-events: none; opacity: 0.6; }
  </style>
</head>
<body>
<a-scene>
  <a-assets id="assets"></a-assets>

  <a-entity id="cameraRig" camera look-controls position="0 1.6 0" raycaster="objects: .hotspot">
    <!-- مؤشر دائم ومرئي أمام الكاميرا -->
    <a-entity position="0 0 -1">
      <a-ring
        radius-inner="0.02"
        radius-outer="0.03"
        color="white"
        material="shader: flat; depthTest: false; depthWrite: false">
      </a-ring>
    </a-entity>

    <!-- HUD: اسم المشهد -->
    <a-entity id="hudGroup" position="-1.2 0.8 -1">
      <a-plane 
        id="hudBg"
        width="0.45"
        height="0.12"
        material="color: #000000; opacity: 0.5; side: double; transparent: true; depthTest: false; depthWrite: false">
      </a-plane>
      <a-text 
        id="sceneLabel"
        value="Loading..."
        position="0 0 0.01"
        align="center"
        color="#FFFFFF"
        width="0.9">
      </a-text>
    </a-entity>
  </a-entity>

  <a-sky id="skyA" rotation="0 -90 0" material="shader: flat; opacity: 1; transparent: true; side: back"></a-sky>
  <a-sky id="skyB" rotation="0 -90 0" material="shader: flat; opacity: 0; transparent: true; side: back"></a-sky>

  <a-entity id="hotspotContainer"></a-entity>

  <a-assets>
    <audio id="transitionSound" src="assets/transition.mp3"></audio>
  </a-assets>
</a-scene>

<script>
// --- بيانات المشاهد ---
const scenes = {
  Living_Room: { src: 'assets/Living_Room.jpg', hotspots: [
      { target: 'Kitchen', position: '-3 1.6 4', img: 'assets/link2.png', size: 0.8 },
      { target: 'Reception', position: '-3 1.6 -1.7', img: 'assets/link.png', size: 0.6 },
      { target: 'Corridor', position: '3 1.6 3', img: 'assets/link1.png', size: 1 }
    ]
  },
  Kitchen: { src: 'assets/Kitchen.jpg', hotspots: [ { target: 'Living_Room', position: '4 1.6 -7', img: 'assets/link2.png', size: 0.7 } ] },
  Reception: { src: 'assets/Reception.jpg', hotspots: [ { target: 'Living_Room', position: '5 1.6 -1', img: 'assets/link.png', size: 0.6 } ] },
  Corridor: { src: 'assets/Corridor.jpg', hotspots: [
      { target: 'Bathroom', position: '3 1.6 -0.5', img: 'assets/link2.png', size: 0.9 },
      { target: 'Bedroom', position: '-0.2 1.6 -3.5', img: 'assets/link2.png', size: 0.7 },
      { target: 'Living_Room', position: '1 1.6 3', img: 'assets/link2.png', size: 0.8 }
    ]
  },
  Bathroom: { src: 'assets/Bathroom.jpg', hotspots: [ { target: 'Corridor', position: '-1 1.6 4', img: 'assets/link1.png', size: 0.6 } ] },
  Bedroom: { src: 'assets/Bedroom.jpg', hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.7 } ] }
};

// --- المتغيرات ---
let isTransitioning = false;
let currentSky = 'A';
function easeInOutQuad(t){ return t<0.5?2*t*t:-1+(4-2*t)*t; }

// --- مساعد تحميل الصور ---
function ensureAssetImageElement(sceneName,url){
  const id = `img-${sceneName}`;
  const assets = document.querySelector('#assets');
  let img = document.getElementById(id);
  if(!img){
    img = document.createElement('img');
    img.setAttribute('id',id);
    img.setAttribute('crossorigin','anonymous');
    img.setAttribute('src',url);
    assets.appendChild(img);
  }
  return img;
}

// --- مساعد توليد توهج ---
function makeGlowDataURL(size=512,colorCenter='255,240,200',colorMid='0,128,255'){
  const canvas=document.createElement('canvas'); canvas.width=canvas.height=size;
  const ctx=canvas.getContext('2d');
  const grad=ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
  grad.addColorStop(0,`rgba(${colorCenter},0.95)`); grad.addColorStop(0.25,`rgba(${colorMid},0.7)`);
  grad.addColorStop(0.5,`rgba(${colorMid},0.4)`); grad.addColorStop(1,`rgba(${colorMid},0)`);
  ctx.fillStyle=grad; ctx.fillRect(0,0,size,size); return canvas.toDataURL();
}
function cleanupGlowAssets(){
  const assets=document.querySelector('#assets');
  assets.querySelectorAll('img').forEach(img=>{ if(img.id.startsWith('glow-')) img.remove(); });
}

// --- إنشاء الهوت سبوت ---
function createHotspots(sceneName){
  const container=document.querySelector('#hotspotContainer');
  container.innerHTML=''; cleanupGlowAssets();
  scenes[sceneName].hotspots.forEach((hs,idx)=>{
    const glowId=`glow-${sceneName}-${idx}-${Date.now()}`;
    const glowImg=document.createElement('img'); glowImg.setAttribute('id',glowId); glowImg.setAttribute('src',makeGlowDataURL(512));
    document.querySelector('#assets').appendChild(glowImg);

    const el=document.createElement('a-plane');
    el.setAttribute('class','hotspot'); el.setAttribute('position',hs.position);
    el.setAttribute('width',hs.size||0.6); el.setAttribute('height',hs.size||0.6);
    el.setAttribute('material',`src: url(${hs.img}); transparent: true; shader: flat; opacity:1`);
    el.setAttribute('look-at','#cameraRig'); el.setAttribute('animation__pulse','property: scale; dir: alternate; dur: 1500; loop: true; to:1.3 1.3 1.3');
    el.setAttribute('visible',true);

    const glow=document.createElement('a-plane');
    glow.setAttribute('position',hs.position);
    const glowScale=(hs.size||0.6)*1.6;
    glow.setAttribute('width',glowScale); glow.setAttribute('height',glowScale);
    glow.setAttribute('look-at','#cameraRig');
    glow.setAttribute('material',`src: #${glowId}; transparent: true; shader: flat; depthTest: false; opacity:0`);
    glow.setAttribute('visible',false);

    const pos=hs.position.split(' ');
    const label=document.createElement('a-text');
    label.setAttribute('value', hs.target.replace('_',' '));
    label.setAttribute('align','center'); label.setAttribute('color','#FFFFFF'); label.setAttribute('width',4);
    label.setAttribute('look-at','#cameraRig'); label.setAttribute('position',`${pos[0]} ${parseFloat(pos[1])+0.6} ${pos[2]}`);
    label.setAttribute('scale','0 0 0'); label.setAttribute('visible',true);

    el.addEventListener('mouseenter',()=>{
      if(isTransitioning) return;
      el.removeAttribute('animation__pulse');
      el.setAttribute('animation__hover','property: scale; to:1.5 1.5 1.5; dur:180; easing:easeOutQuad');
      label.removeAttribute('animation__scalefadeout');
      label.setAttribute('animation__scalefadein','property: scale; to:1 1 1; dur:300; easing:easeOutQuad');
      glow.setAttribute('visible',true); glow.removeAttribute('animation__fadeout'); glow.setAttribute('animation__fadein','property: material.opacity; to:0.85; dur:200; easing:easeOutQuad');
      glow.removeAttribute('animation__glowscaleback'); glow.setAttribute('animation__glowscale','property: scale; to:1.25 1.25 1.25; dur:200; easing:easeOutQuad');
    });

    el.addEventListener('mouseleave',()=>{
      if(isTransitioning) return;
      el.removeAttribute('animation__hover'); el.setAttribute('scale','1 1 1');
      el.setAttribute('animation__pulse','property: scale; dir: alternate; dur: 1500; loop: true; to:1.3 1.3 1.3');
      label.removeAttribute('animation__scalefadein'); label.setAttribute('animation__scalefadeout','property: scale; to:0 0 0; dur:300; easing:easeOutQuad');
      glow.removeAttribute('animation__fadein'); glow.setAttribute('animation__fadeout','property: material.opacity; to:0; dur:300; easing:easeOutQuad');
      glow.removeAttribute('animation__glowscale'); glow.setAttribute('animation__glowscaleback','property: scale; to:1 1 1; dur:300; easing:easeOutQuad');
      setTimeout(()=>{ try{ glow.setAttribute('visible','false'); }catch(e){} },320);
    });

    el.addEventListener('click',()=>{
      if(isTransitioning) return;
      const audio=document.querySelector('#transitionSound'); audio.pause(); audio.currentTime=0; audio.play().catch(()=>{});
      changeScene(hs.target);
    });

    container.appendChild(glow); container.appendChild(el); container.appendChild(label);
  });
}

// --- تغيير المشهد ---
async function changeScene(sceneName, instant=false, duration=450){
  if(isTransitioning) return;
  isTransitioning=true;

  const skyA=document.querySelector('#skyA'); const skyB=document.querySelector('#skyB');
  document.querySelector('#sceneLabel').setAttribute('value',sceneName.replace('_',' '));
  const imgEl=ensureAssetImageElement(sceneName,scenes[sceneName].src);
  try{ if(!imgEl.complete) await imgEl.decode(); }catch(e){ console.warn(e); }

  if(instant){
    skyA.setAttribute('material',`src: #img-${sceneName}; shader: flat; opacity:1; transparent:true; side:back`);
    skyB.setAttribute('material',`src: #img-${sceneName}; shader: flat; opacity:0; transparent:true; side:back`);
    currentSky='A'; createHotspots(sceneName); isTransitioning=false; return;
  }

  const showSky=currentSky==='A'?skyB:skyA; const hideSky=currentSky==='A'?skyA:skyB;
  showSky.setAttribute('material',`src: #img-${sceneName}; shader: flat; opacity:0; transparent:true; side:back`);
  document.querySelectorAll('.hotspot').forEach(el=>el.classList.add('disabled'));

  const showMesh=showSky.getObject3D('mesh'); const hideMesh=hideSky.getObject3D('mesh');
  const start=performance.now();

  requestAnimationFrame(function frame(now){
    let t=(now-start)/duration; if(t>1)t=1;
    const eased=easeInOutQuad(t);
    if(showMesh && hideMesh){
      try{
        if(Array.isArray(showMesh.material)) showMesh.material.forEach(m=>m.opacity=eased);
        else showMesh.material.opacity=eased;
        if(Array.isArray(hideMesh.material)) hideMesh.material.forEach(m=>m.opacity=1-eased);
        else hideMesh.material.opacity=1-eased;
      }catch{
        showSky.setAttribute('material',`src: #img-${sceneName}; shader: flat; opacity:${eased}; transparent:true; side:back`);
        hideSky.setAttribute('material',`opacity:${1-eased}`);
      }
    }

    if(t<1) requestAnimationFrame(frame);
    else{
      currentSky=currentSky==='A'?'B':'A';
      createHotspots(sceneName);
      document.querySelectorAll('.hotspot').forEach(el=>el.classList.remove('disabled'));
      isTransitioning=false;
    }
  });
}

// --- بداية التحميل ---
window.addEventListener('load',()=>{
  document.body.addEventListener('click',()=>{
    const audio=document.querySelector('#transitionSound');
    audio.play().catch(()=>{});
  },{once:true});
  changeScene('Living_Room',true);
});
</script>
</body>
</html>
