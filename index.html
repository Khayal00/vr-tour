<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Tour with Gaze Progress Ring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
      #welcomeScreen {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: linear-gradient(135deg,#1a1a1a,#000000);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        color:white; z-index:9999;
      }
      #welcomeScreen h1 { font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 8px rgba(255,255,255,0.6); }
      #instructions { font-size: 1em; margin-bottom: 30px; opacity: 0.85; }
      .progress-container { width: 60%; background: rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; height: 20px; margin-bottom: 25px; }
      .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe, #00f2fe); transition: width 0.3s; }
      #startBtn { padding: 12px 28px; border: none; border-radius: 30px; background: #4facfe; color: white; font-size: 1.1em; cursor: pointer; display:none; }
      #startBtn:hover { background: #00f2fe; }
    </style>

    <script>
      // Component لشريط التقدم حول المؤشر
      AFRAME.registerComponent('progress-ring', {
        schema: {
          color: {type: 'color', default: '#00f2fe'},
          duration: {type: 'number', default: 1600} // مدة شريط التقدم
        },
        init: function () {
          const el = this.el;
          this.progress = 0;
          this.isFusing = false;

          el.addEventListener('mouseenter', () => {
            this.isFusing = true;
            this.startTime = Date.now();
            el.setAttribute('material', 'color', this.data.color);
          });

          el.addEventListener('mouseleave', () => {
            this.isFusing = false;
            this.progress = 0;
            el.setAttribute('material', 'color', 'white');
            el.setAttribute('geometry', 'thetaLength', 0);
          });
        },
        tick: function () {
          if (!this.isFusing) return;
          const elapsed = Date.now() - this.startTime;
          this.progress = elapsed / this.data.duration;
          if (this.progress >= 1) {
            this.progress = 1;
            this.isFusing = false;
            el.emit('fuse-complete'); // حدث عند اكتمال التقدم
          }
          this.el.setAttribute('geometry', 'thetaLength', 360 * this.progress);
        }
      });
    </script>
  </head>

  <body>
    <div id="welcomeScreen">
      <h1>✨ VR Tour ✨</h1>
      <div id="instructions">استخدم الماوس/النظر أو وحدات التحكم للتنقّل</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <button id="startBtn">ابدأ الجولة</button>
    </div>

    <a-scene renderer="colorManagement: true; antialias: true">
      <!-- الكاميرا + المؤشر -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-entity camera look-controls>
          <a-entity id="cursorContainer" position="0 0 -1">
            <a-cursor id="cursor"
                      fuse="true" fuse-timeout="1600"
                      geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02; thetaStart: 0; thetaLength: 0"
                      material="color: white; shader: flat; opacity: 0.9; side: double; depthTest: false"
                      raycaster="objects: .hotspot"
                      progress-ring="color: #00f2fe; duration: 1600">
            </a-cursor>
          </a-entity>
        </a-entity>

        <a-entity laser-controls="hand: right" raycaster="objects: .hotspot"></a-entity>
        <a-entity laser-controls="hand: left"  raycaster="objects: .hotspot"></a-entity>
      </a-entity>

      <a-sky id="skyFront" rotation="0 -90 0" src="#imgLiving" material="shader: flat; transparent: true; opacity: 1"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0" material="shader: flat; transparent: true; opacity: 0"></a-sky>
      <a-entity id="hotspotContainer"></a-entity>

      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3"></audio>
        <img id="imgLiving"   src="assets/Living_Room.jpg">
        <img id="imgKitchen"  src="assets/Kitchen.jpg">
        <img id="imgReception"src="assets/Reception.jpg">
        <img id="imgCorridor" src="assets/Corridor.jpg">
        <img id="imgBathroom" src="assets/Bathroom.jpg">
        <img id="imgBedroom"  src="assets/Bedroom.jpg">
      </a-assets>
    </a-scene>

    <script>
      const cursor = document.querySelector('#cursor');
      cursor.addEventListener('fuse-complete', () => {
        const hotspot = document.querySelector('.hotspot:hover'); // العنصر المقصود عند اكتمال التقدم
        if (hotspot) hotspot.click();
      });

      // هنا يمكنك إضافة الكود السابق لإدارة المشاهد والهوت سبوتات كما هو لديك
      // أي: createHotspots() و changeScene() و welcomeScreen logic
    </script>
  </body>
</html>
