<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Tour with Glow & Fuse Cursor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #welcomeScreen {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: #000; color: #fff; font-family: sans-serif; z-index: 9999;
      }
      #progressBarContainer {
        width: 50%; height: 10px; background: #444; margin: 15px 0;
      }
      #progressBar {
        width: 0; height: 100%; background: #0f0; transition: width 0.2s;
      }
      #startBtn {
        padding: 10px 20px; background: #0f0; border: none; cursor: pointer;
        font-size: 18px; display: none; border-radius: 6px;
      }
      #hud {
        position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
        color: #fff; font-size: 20px; font-family: sans-serif; z-index: 5;
        text-shadow: 0 0 5px #000;
      }
    </style>
  </head>
  <body>
    <!-- شاشة الترحيب -->
    <div id="welcomeScreen">
      <h1>مرحباً بك في الجولة الافتراضية</h1>
      <div id="progressBarContainer"><div id="progressBar"></div></div>
      <button id="startBtn">ابدأ الجولة</button>
    </div>

    <!-- HUD -->
    <div id="hud"></div>

    <a-scene>
      <a-assets>
        <!-- صور المشاهد -->
        <img id="Living_Room" src="scene1.jpg" crossorigin="anonymous"/>
        <img id="Hall" src="scene2.jpg" crossorigin="anonymous"/>
      </a-assets>

      <!-- السماء -->
      <a-sky id="sky" radius="30" src="#Living_Room"></a-sky>

      <!-- الكاميرا مع المؤشر gaze -->
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera>
          <a-cursor id="cursor"
            fuse="true" fuse-timeout="1500"
            raycaster="objects: .hotspot"
            geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.025"
            material="color: white; shader: flat">
          </a-cursor>
        </a-camera>
      </a-entity>
    </a-scene>

    <script>
      const hud = document.getElementById('hud');
      const sky = document.getElementById('sky');
      const cursor = document.querySelector('#cursor');

      // قائمة المشاهد
      const scenes = {
        "Living_Room": {
          name: "غرفة المعيشة",
          hotspots: [
            {position: "2 1.5 -3", target: "Hall"}
          ]
        },
        "Hall": {
          name: "القاعة",
          hotspots: [
            {position: "-2 1.5 3", target: "Living_Room"}
          ]
        }
      };

      let currentScene = null;

      // إنشاء الهوت سبوتات
      function createHotspot(hs) {
        const wrapper = document.createElement('a-entity');

        const plane = document.createElement('a-plane');
        plane.setAttribute('class', 'hotspot');
        plane.setAttribute('src', '#hotspotIcon');
        plane.setAttribute('height', '0.5');
        plane.setAttribute('width', '0.5');
        plane.setAttribute('look-at', '#cameraRig');
        plane.setAttribute('position', hs.position);

        // أنيميشن الظهور
        plane.setAttribute('animation__pop', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutElastic');

        // توهج
        const glow = document.createElement('a-circle');
        glow.setAttribute('radius', 1.2);
        glow.setAttribute('color', '#fff');
        glow.setAttribute('opacity', 0.35);
        glow.setAttribute('look-at', '#cameraRig');
        glow.setAttribute('position', hs.position);
        glow.setAttribute('animation__pulse','property: scale; dir: alternate; dur: 2000; loop: true; to: 1.5 1.5 1');

        // عند الكليك → انتقال للمشهد
        plane.addEventListener('click', () => changeScene(hs.target, 800));

        wrapper.appendChild(glow);
        wrapper.appendChild(plane);
        return wrapper;
      }

      // تحميل مشهد
      function changeScene(sceneId, duration=1000) {
        if (!scenes[sceneId]) return;
        currentScene = sceneId;
        hud.innerText = scenes[sceneId].name;

        // Fade Out ثم تغيير الصورة ثم Fade In
        let opacity = 1;
        function fadeOut() {
          opacity -= 0.05;
          if (opacity <= 0) {
            sky.setAttribute('src', '#' + sceneId);
            clearHotspots();
            scenes[sceneId].hotspots.forEach(hs => {
              const hotspot = createHotspot(hs);
              sky.parentNode.appendChild(hotspot);
            });
            fadeIn();
          } else {
            sky.setAttribute('material', 'opacity: '+opacity);
            requestAnimationFrame(fadeOut);
          }
        }
        function fadeIn() {
          opacity += 0.05;
          if (opacity >= 1) return;
          sky.setAttribute('material', 'opacity: '+opacity);
          requestAnimationFrame(fadeIn);
        }
        fadeOut();
      }

      // إزالة الهوت سبوتات
      function clearHotspots() {
        document.querySelectorAll('.hotspot').forEach(hs => hs.parentNode.remove());
      }

      // المؤشر يتغير لونه
      cursor.addEventListener('fusing', () => {
        cursor.setAttribute('material', 'color: lime');
      });
      cursor.addEventListener('mouseleave', () => {
        cursor.setAttribute('material', 'color: white');
      });
      cursor.addEventListener('click', () => {
        cursor.setAttribute('material', 'color: white');
      });

      // شاشة الترحيب
      const assets=document.querySelector('a-assets');
      const progressBar=document.getElementById('progressBar');
      const startBtn=document.getElementById('startBtn');
      const welcomeScreen=document.getElementById('welcomeScreen');

      assets.addEventListener('progress',(e)=>{
        const loaded=e.detail&&e.detail.loadedBytes?e.detail.loadedBytes:0;
        const total=e.detail&&e.detail.totalBytes?e.detail.totalBytes:0;
        const percent=total>0?Math.floor((loaded/total)*100):0;
        progressBar.style.width=percent+'%';
      });

      assets.addEventListener('loaded',()=>{
        progressBar.style.width='100%';
        startBtn.style.display='block';
      });

      startBtn.addEventListener('click',()=>{
        welcomeScreen.style.transition='opacity 0.7s';
        welcomeScreen.style.opacity='0';
        setTimeout(()=>{ welcomeScreen.style.display='none'; },700);
        changeScene('Living_Room',800);
      });
    </script>
  </body>
</html>
