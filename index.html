<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VR Tour with Welcome Screen - Reliable Smooth Transition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }

      /* شاشة الترحيب */
      #welcomeScreen {
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: linear-gradient(135deg,#1a1a1a,#000000);
        display:flex; flex-direction:column;
        align-items:center; justify-content:center;
        color:white; z-index:9999;
      }
      #welcomeScreen h1 {
        font-size: 2.5em;
        margin-bottom: 20px;
        text-shadow: 0 0 8px rgba(255,255,255,0.6);
      }
      #instructions {
        font-size: 1em;
        margin-bottom: 30px;
        opacity: 0.85;
      }
      .progress-container {
        width: 60%;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        overflow: hidden;
        height: 20px;
        margin-bottom: 25px;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4facfe, #00f2fe);
        transition: width 0.3s;
      }
      #startBtn {
        padding: 12px 28px;
        border: none;
        border-radius: 30px;
        background: #4facfe;
        color: white;
        font-size: 1.1em;
        cursor: pointer;
        display:none;
      }
      #startBtn:hover { background: #00f2fe; }
    </style>
  </head>
  <body>
    <!-- شاشة الترحيب -->
    <div id="welcomeScreen">
      <h1>✨ VR Tour ✨</h1>
      <div id="instructions">استخدم الماوس أو الهاتف أو نظارة VR للتحريك والنظر حولك</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <button id="startBtn">ابدأ الجولة</button>
    </div>

    <!-- المشهد -->
    <a-scene>
      <a-entity id="cameraRig" position="0 1.6 0">
        <a-camera look-controls>
          <a-cursor
            id="cursor"
            fuse="false"
            raycaster="objects: .hotspot"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: white; shader: flat">
          </a-cursor>
        </a-camera>
      </a-entity>

      <!-- HUD -->
      <a-text id="sceneLabel" value="Living Room" position="-1.2 0.8 -1"
        align="center" color="#FFFFFF" width="1"></a-text>

      <a-entity id="hudPlane" position="-1.2 0.8 -1">
        <a-plane width="0.3" height="0.1"
          material="color: #000000; opacity: 0.5; side: double; transparent: true">
        </a-plane>
      </a-entity>

      <!-- سماءان للـ crossfade -->
      <a-sky id="skyFront" rotation="0 -90 0" visible="true"
             material="shader: flat; transparent: true; opacity: 1"></a-sky>
      <a-sky id="skyBack" rotation="0 -90 0" visible="true"
             material="shader: flat; transparent: true; opacity: 0"></a-sky>

      <a-entity id="hotspotContainer"></a-entity>

      <a-assets>
        <audio id="transitionSound" src="assets/transition.mp3"></audio>
        <!-- صور المشاهد -->
        <img id="imgLiving" src="assets/Living_Room.jpg">
        <img id="imgKitchen" src="assets/Kitchen.jpg">
        <img id="imgReception" src="assets/Reception.jpg">
        <img id="imgCorridor" src="assets/Corridor.jpg">
        <img id="imgBathroom" src="assets/Bathroom.jpg">
        <img id="imgBedroom" src="assets/Bedroom.jpg">
      </a-assets>
    </a-scene>

    <script>
      // تعريف المشاهد والهوت سبوت
      const scenes = {
        Living_Room: {
          src: '#imgLiving',
          hotspots: [
            { target: 'Kitchen',   position: '-3 1.6 4',   img: 'assets/link2.png', size: 0.6 },
            { target: 'Reception', position: '-3 1.6 -1.7', img: 'assets/link.png',  size: 0.6 },
            { target: 'Corridor',  position: '3 1.6 3',    img: 'assets/link1.png', size: 0.6 }
          ]
        },
        Kitchen:    { src: '#imgKitchen',   hotspots: [ { target: 'Living_Room', position: '4 1.6 -7', img: 'assets/link2.png', size: 0.8 } ] },
        Reception:  { src: '#imgReception', hotspots: [ { target: 'Living_Room', position: '5 1.6 -1',  img: 'assets/link.png',  size: 0.6 } ] },
        Corridor: {
          src: '#imgCorridor',
          hotspots: [
            { target: 'Bathroom',   position: '3 1.6 -0.5',  img: 'assets/link2.png', size: 0.6 },
            { target: 'Bedroom',    position: '-0.2 1.6 -3.5',img: 'assets/link2.png', size: 0.6 },
            { target: 'Living_Room',position: '1 1.6 3',     img: 'assets/link2.png', size: 0.6 }
          ]
        },
        Bathroom:   { src: '#imgBathroom',  hotspots: [ { target: 'Corridor', position: '-1 1.6 4', img: 'assets/link1.png', size: 0.6 } ] },
        Bedroom:    { src: '#imgBedroom',   hotspots: [ { target: 'Corridor', position: '-0.5 1.6 4', img: 'assets/link1.png', size: 0.6 } ] }
      };

      // إنشاء هوت سبوتات المشهد
      function createHotspots(sceneName) {
        const hotspotContainer = document.querySelector('#hotspotContainer');
        hotspotContainer.innerHTML = '';
        const scene = scenes[sceneName] || { hotspots: [] };

        scene.hotspots.forEach((hs, idx) => {
          const el = document.createElement('a-plane');
          el.setAttribute('class', 'hotspot');
          el.setAttribute('position', hs.position);
          el.setAttribute('width', hs.size || 0.6);
          el.setAttribute('height', hs.size || 0.6);
          el.setAttribute('material', `src: url(${hs.img}); transparent: true; shader: flat; opacity: 1`);
          el.setAttribute('look-at', '#cameraRig');
          el.setAttribute('scale', '0 0 0');
          el.setAttribute('animation__popin', 'property: scale; to: 1 1 1; dur: 600; easing: easeOutBack');

          el.addEventListener('animationcomplete__popin', () => {
            el.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 1500; loop: true; to: 1.3 1.3 1.3');
          });

          el.addEventListener('click', () => { changeScene(hs.target); });

          hotspotContainer.appendChild(el);
        });
      }

      // ====== Crossfade ======
      let currentFadeRAF = null;

      function setSkyOpacity(skyEl, value) {
        const mesh = skyEl.getObject3D('mesh');
        if (mesh && mesh.material) {
          mesh.material.transparent = true;
          mesh.material.opacity = value;
          mesh.material.needsUpdate = true;
        }
      }

      function changeScene(sceneName, duration = 700) {
        const skyFront = document.querySelector('#skyFront');
        const skyBack  = document.querySelector('#skyBack');
        const hotspotContainer = document.querySelector('#hotspotContainer');
        const audio = document.querySelector('#transitionSound');

        if (currentFadeRAF) { cancelAnimationFrame(currentFadeRAF); currentFadeRAF = null; }

        Array.from(hotspotContainer.children).forEach(el => { el.setAttribute('visible','false'); });

        skyBack.setAttribute('src', scenes[sceneName].src);
        setSkyOpacity(skyBack, 0);

        try { audio.pause(); audio.currentTime = 0; audio.play().catch(()=>{}); } catch(e){}

        const start = performance.now();
        const dur = Math.max(50, duration);
        function step(now) {
          const t = Math.min(1, (now - start) / dur);
          const ease = t < 0.5 ? 2*t*t : -1 + (4 - 2*t)*t;
          setSkyOpacity(skyBack, ease);
          setSkyOpacity(skyFront, 1 - ease);

          if (t < 1) {
            currentFadeRAF = requestAnimationFrame(step);
          } else {
            currentFadeRAF = null;
            skyFront.setAttribute('src', scenes[sceneName].src);
            setSkyOpacity(skyFront, 1);
            setSkyOpacity(skyBack, 0);
            // 👇 لا نحذف src من skyBack

            document.querySelector('#sceneLabel').setAttribute('value', sceneName.replace('_',' '));
            createHotspots(sceneName);
          }
        }
        currentFadeRAF = requestAnimationFrame(step);
      }

      // ====== شاشة الترحيب ======
      const assets = document.querySelector('a-assets');
      const progressBar = document.getElementById('progressBar');
      const startBtn = document.getElementById('startBtn');
      const welcomeScreen = document.getElementById('welcomeScreen');

      assets.addEventListener('progress', (e) => {
        const loaded = e.detail && e.detail.loadedBytes ? e.detail.loadedBytes : 0;
        const total  = e.detail && e.detail.totalBytes  ? e.detail.totalBytes  : 0;
        const percent = total > 0 ? Math.floor((loaded/total)*100) : 0;
        progressBar.style.width = percent + '%';
      });

      assets.addEventListener('loaded', () => {
        progressBar.style.width = '100%';
        startBtn.style.display = 'block';
      });

      startBtn.addEventListener('click', () => {
        welcomeScreen.style.transition = 'opacity 0.7s';
        welcomeScreen.style.opacity = '0';
        setTimeout(() => { welcomeScreen.style.display = 'none'; }, 700);
        changeScene('Living_Room', 800);
      });
    </script>
  </body>
</html>
