<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>جولة الواقع الافتراضي التفاعلية</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none; /* يمنع التفاعل مع الشاشة بعد إخفائها */
        }
        #welcome-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        #welcome-screen p {
            font-size: 1.2em;
            max-width: 600px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        #start-button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #start-button:hover {
            background-color: #45a049;
        }
        /* تخصيص شريط التحميل الافتراضي لـ A-Frame */
       .a-loader-title {
            color: #FFF!important; /* لون النص لشريط التحميل */
            font-size: 1.5em!important;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
       .a-loader-dots {
            color: #FFD700!important; /* لون النقاط لشريط التحميل */
        }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1>مرحباً بكم في الجولة الافتراضية!</h1>
        <p>استكشف الفضاءات بتقنية 360 درجة. للتنقل، انظر إلى النقاط النابضة أو استخدم الماوس/شاشة اللمس. انقر على النقطة الساخنة للانتقال إلى المشهد التالي.</p>
        <button id="start-button">بدء الجولة</button>
    </div>

    <a-scene loading-screen="dotsColor: #FFD700; backgroundColor: #222; enabled: true">
        <a-assets timeout="10000">
            <img id="reception-pano" src="assets/reception.jpg" crossorigin="anonymous">
            <img id="living_room-pano" src="assets/living_room.jpg" crossorigin="anonymous">
            <img id="kitchen-pano" src="assets/kitchen.jpg" crossorigin="anonymous">
            <img id="corridor-pano" src="images/corridor.jpg" crossorigin="anonymous">
            <img id="bedroom-pano" src="images/bedroom.jpg" crossorigin="anonymous">
            <img id="bathroom-pano" src="images/bathroom.jpg" crossorigin="anonymous">

            <img id="hotspot-arrow-png" src="assets/hotspot.png" crossorigin="anonymous">
        </a-assets>

        <a-sky id="main-panorama" src="#reception-pano"></a-sky>

        <a-plane id="transition-overlay"
                 position="0 0 -1"
                 width="100" height="100"
                 material="color: black; opacity: 0; transparent: true; shader: flat"
                 visible="false">
            <a-animation attribute="material.opacity" from="0" to="1" dur="500" begin="fadein" easing="ease-in-quad"></a-animation>
            <a-animation attribute="material.opacity" from="1" to="0" dur="500" begin="fadeout" easing="ease-out-quad"></a-animation>
        </a-plane>

        <a-entity camera look-controls>
            <a-entity cursor="fuse: true; fuseTimeout: 1500; rayOrigin: mouse"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: #CCC; shader: flat"
                      animation__fusing="property: scale; from: 1 1 1; to: 0.8 0.8 0.8; startEvents: fusing; dur: 1500; easing: linear;"
                      animation__click="property: scale; from: 0.8 0.8 0.8; to: 1 1 1; startEvents: click; dur: 100; easing: easeOutQuad;">
            </a-entity>
        </a-entity>

        <a-entity id="hotspot-container"></a-entity>

    </a-scene>

    <script>
        // بيانات الجولة: مسارات الصور ومواقع النقاط الساخنة
        const tourScenes = {
            "Reception": {
                image: "#reception-pano",
                hotspots:
            },
            "Living_Room": {
                image: "#living_room-pano",
                hotspots:
            },
            "Kitchen": {
                image: "#kitchen-pano",
                hotspots:
            },
            "Corridor": {
                image: "#corridor-pano",
                hotspots:
            },
            "Bedroom": {
                image: "#bedroom-pano",
                hotspots: [
                    { target: "Corridor", position: "0 1.5 3", rotation: "0 180 0", text: "الممر" }
                ]
            },
            "Bathroom": {
                image: "#bathroom-pano",
                hotspots: [
                    { target: "Corridor", position: "0 1.5 3", rotation: "0 180 0", text: "الممر" }
                ]
            }
        };

        let currentSceneId = "Reception"; // المشهد الأولي

        // مكون A-Frame مخصص لإدارة الانتقالات بين المشاهد والنقاط الساخنة
        AFRAME.registerComponent('scene-transition-manager', {
            init: function () {
                this.sky = document.querySelector('#main-panorama');
                this.transitionOverlay = document.querySelector('#transition-overlay');
                this.hotspotContainer = document.querySelector('#hotspot-container');

                // الاستماع لحدث النقر على النقطة الساخنة
                this.el.sceneEl.addEventListener('hotspot-clicked', (evt) => {
                    const nextSceneId = evt.detail.targetScene;
                    this.transitionToScene(nextSceneId);
                });

                // الاستماع لاكتمال رسوم متحركة التلاشي للداخل
                this.transitionOverlay.addEventListener('animationcomplete__fadein', () => {
                    // بمجرد أن يصبح التراكب معتمًا بالكامل، قم بتبديل صورة السماء
                    this.sky.setAttribute('src', tourScenes.image);
                    // ثم ابدأ رسوم متحركة التلاشي للخارج
                    this.transitionOverlay.emit('fadeout');
                });

                // الاستماع لاكتمال رسوم متحركة التلاشي للخارج
                this.transitionOverlay.addEventListener('animationcomplete__fadeout', () => {
                    this.transitionOverlay.setAttribute('visible', false); // إخفاء التراكب
                    this.updateHotspots(currentSceneId); // إظهار النقاط الساخنة للمشهد الجديد
                });
            },

            // وظيفة للانتقال إلى مشهد جديد
            transitionToScene: function (sceneId) {
                if (currentSceneId === sceneId) return; // لا تفعل شيئًا إذا كان نفس المشهد

                currentSceneId = sceneId;
                this.updateHotspots(null); // إخفاء جميع النقاط الساخنة الحالية
                this.transitionOverlay.setAttribute('visible', true); // جعل التراكب مرئيًا
                this.transitionOverlay.emit('fadein'); // تشغيل رسوم متحركة التلاشي للداخل
            },

            // وظيفة لتحديث النقاط الساخنة بناءً على المشهد الحالي
            updateHotspots: function (sceneId) {
                // إزالة جميع النقاط الساخنة الموجودة
                while (this.hotspotContainer.firstChild) {
                    this.hotspotContainer.removeChild(this.hotspotContainer.firstChild);
                }

                if (!sceneId ||!tourScenes[sceneId] ||!tourScenes[sceneId].hotspots) {
                    return; // لا توجد نقاط ساخنة لعرضها
                }

                // إنشاء النقاط الساخنة للمشهد الجديد
                tourScenes[sceneId].hotspots.forEach(hotspotData => {
                    const hotspotEl = document.createElement('a-entity');
                    hotspotEl.setAttribute('class', 'hotspot');
                    hotspotEl.setAttribute('position', hotspotData.position);
                    hotspotEl.setAttribute('rotation', hotspotData.rotation);
                    hotspotEl.setAttribute('hotspot-listener', `targetScene: ${hotspotData.target}`);
                    hotspotEl.setAttribute('pulsing-hotspot', ''); // لتطبيق تأثير النبض

                    // صورة النقطة الساخنة
                    const hotspotImage = document.createElement('a-image');
                    hotspotImage.setAttribute('src', '#hotspot-arrow-png');
                    hotspotImage.setAttribute('width', '0.8');
                    hotspotImage.setAttribute('height', '0.8');
                    hotspotImage.setAttribute('material', 'shader: flat; transparent: true');
                    hotspotImage.setAttribute('position', '0 0 0'); // الصورة في مركز الكيان الأب

                    // نص النقطة الساخنة (يظهر عند التمرير)
                    const hotspotText = document.createElement('a-entity');
                    hotspotText.setAttribute('id', `hotspot-text-${hotspotData.target}`);
                    hotspotText.setAttribute('text', `value: ${hotspotData.text}; align: center; color: white; width: 2; wrapCount: 15;`);
                    hotspotText.setAttribute('position', '0 0.6 0'); // فوق الصورة
                    hotspotText.setAttribute('visible', 'false'); // مخفي في البداية

                    hotspotEl.appendChild(hotspotImage);
                    hotspotEl.appendChild(hotspotText);
                    this.hotspotContainer.appendChild(hotspotEl);

                    // إضافة تأثير التكبير وعرض النص عند التمرير
                    hotspotEl.setAttribute('event-set__mouseenter', `_target: ${hotspotText.id}; visible: true;`);
                    hotspotEl.setAttribute('event-set__mouseleave', `_target: ${hotspotText.id}; visible: false;`);
                    hotspotEl.setAttribute('event-set__mouseenter-scale', 'scale: 1.2 1.2 1.2;');
                    hotspotEl.setAttribute('event-set__mouseleave-scale', 'scale: 1 1 1;');
                });
            }
        });

        // مكون A-Frame مخصص لتشغيل رسوم متحركة النبض
        AFRAME.registerComponent('pulsing-hotspot', {
            init: function () {
                this.el.setAttribute('animation__pulse', {
                    property: 'scale',
                    from: '1 1 1',
                    to: '1.1 1.1 1.1',
                    dur: 1000,
                    dir: 'alternate',
                    loop: true,
                    easing: 'easeInOutQuad'
                });
            }
        });

        // مكون A-Frame مخصص للاستماع إلى نقرات النقاط الساخنة
        AFRAME.registerComponent('hotspot-listener', {
            schema: {
                targetScene: { type: 'string' }
            },
            init: function () {
                this.el.addEventListener('click', () => {
                    // إرسال حدث مخصص إلى المشهد الرئيسي
                    this.el.sceneEl.emit('hotspot-clicked', { targetScene: this.data.targetScene });
                });
            }
        });

        // إخفاء شاشة الترحيب وبدء الجولة عند النقر على الزر
        document.getElementById('start-button').addEventListener('click', () => {
            const welcomeScreen = document.getElementById('welcome-screen');
            welcomeScreen.classList.add('hidden'); // إخفاء الشاشة
            // تهيئة مدير الانتقال وبدء المشهد الأول
            document.querySelector('a-scene').setAttribute('scene-transition-manager', '');
            document.querySelector('a-scene').components['scene-transition-manager'].updateHotspots(currentSceneId);
        });

        // عند تحميل مشهد A-Frame بالكامل، تأكد من إخفاء شاشة التحميل الافتراضية
        // وعرض شاشة الترحيب المخصصة
        document.querySelector('a-scene').addEventListener('loaded', () => {
            // A-Frame's default loading screen is handled by the loading-screen component.
            // Our custom welcome screen is initially visible.
            // The user clicks the button to hide it and start the tour.
        });
    </script>
</body>
</html>
