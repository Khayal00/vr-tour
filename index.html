<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>VR Tour — A-Frame</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body, html { margin:0; height:100%; font-family: sans-serif; background:#000; color:#fff }
    /* Preloader overlay */
    #welcome {
      position: absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(0deg, rgba(0,0,0,0.75), rgba(0,0,0,0.85));
      z-index: 9999; flex-direction: column; gap:16px; padding:20px; text-align:center;
    }
    #panel { max-width:720px; width:90%; background:rgba(255,255,255,0.03); border-radius:10px; padding:18px }
    #progressBar { width:100%; height:12px; background: rgba(255,255,255,0.08); border-radius:8px; overflow:hidden }
    #progressFill { height:100%; width:0%; background: linear-gradient(90deg, rgba(255,255,255,0.12), rgba(255,255,255,0.25)); transition:width 300ms ease }
    button.start {
      margin-top:12px; padding:10px 16px; border-radius:8px; border: none; background:#2196F3; color:white; font-weight:600; cursor:pointer;
    }
    .small { font-size:0.9rem; color:#ddd }
    /* tiny instruction box bottom-left */
    #hint {
      position: absolute; left:12px; bottom:12px; background: rgba(0,0,0,0.4); padding:8px 12px; border-radius:8px; z-index:2000;
      font-size:0.9rem;
    }
  </style>
</head>
<body>

  <!-- WELCOME + LOADER -->
  <div id="welcome" aria-hidden="false">
    <div id="panel">
      <h2>مرحباً بكم في الجولة الافتراضية</h2>
      <p class="small">ضع نظارتك أو استخدم الفأرة / اللمس للتنقل. عند وضع المؤشر على أي نقطة هوت سبوت ستنبض وتكبر، اضغط أو انتظر (gaze) للانتقال.</p>
      <div style="height:12px"></div>
      <div id="progressBar"><div id="progressFill"></div></div>
      <div style="height:8px"></div>
      <div id="progressText" class="small">تحميل الأصول: 0%</div>
      <button id="startBtn" class="start" disabled>ابدأ الجولة</button>
      <div style="height:6px"></div>
      <div class="small">مطلوب HTTPS لعرض الجولة على نظارات VR (Meta Quest).</div>
    </div>
  </div>

  <div id="hint">اضغط على أيقونة الهوت سبوت أو استخدم gaze للانتقال</div>

  <!-- A-Frame Scene -->
  <a-scene embedded renderer="precision: low" vr-mode-ui="enabled: true" background="color: #000">
    <!-- Assets -->
    <a-assets id="assets">
      <!-- 6 Panorama images -->
      <img id="reception" src="assets/reception.jpg" crossorigin="anonymous" />
      <img id="living_room" src="assets/living_room.jpg" crossorigin="anonymous" />
      <img id="kitchen" src="assets/kitchen.jpg" crossorigin="anonymous" />
      <img id="corridor" src="assets/corridor.jpg" crossorigin="anonymous" />
      <img id="bedroom" src="assets/bedroom.jpg" crossorigin="anonymous" />
      <img id="bathroom" src="assets/bathroom.jpg" crossorigin="anonymous" />

      <!-- hotspot icon -->
      <img id="hotspotIcon" src="assets/hotspot.png" crossorigin="anonymous" />

      <!-- a tiny transparent placeholder for sky fallback -->
      <img id="blank" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
    </a-assets>

    <!-- Sky / Panorama -->
    <a-sky id="sky" radius="5000" src="#reception" rotation="0 -90 0"></a-sky>

    <!-- Camera rig (works for desktop, mobile, and Quest controllers) -->
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls wasd-controls>
        <!-- black fade plane attached to camera for transitions -->
        <a-entity id="fadePlane" geometry="primitive: plane; height:1; width:1" position="0 0 -0.6"
                  material="color: black; shader: flat; transparent: true; opacity: 1"></a-entity>
      </a-entity>

      <!-- cursor for desktop/mobile (fuse for gaze) -->
      <a-entity id="cursorEntity" cursor="fuse: true; fuseTimeout: 700" raycaster="objects: .clickable"
                position="0 0 0" ></a-entity>

      <!-- controllers for VR (laser + raycast) -->
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>
    </a-entity>

    <!-- container for hotspots (we'll populate with JS) -->
    <a-entity id="hotspotsRoot"></a-entity>

    <!-- Grid ground far away so mobile doesn't feel empty (optional) -->
    <a-entity position="0 -5 0">
      <a-plane rotation="-90 0 0" width="200" height="200" material="color: #111; opacity: 0.2"></a-plane>
    </a-entity>

    <!-- small help text in the scene (hidden by default) -->
    <a-entity id="sceneInstructions" position="0 2 -1" visible="false">
      <a-plane width="1.8" height="0.4" color="#000" material="opacity:0.5"></a-plane>
      <a-text value="ضع المؤشر على أي نقطة و اضغط للانتقال" align="center" position="0 0 0.01" color="#fff" wrap-count="24"></a-text>
    </a-entity>

  </a-scene>

  <script>
    // ---------- Configuration ----------
    const scenes = {
      "Reception": "#reception",
      "Living_Room": "#living_room",
      "Kitchen": "#kitchen",
      "Corridor": "#corridor",
      "Bedroom": "#bedroom",
      "Bathroom": "#bathroom"
    };

    // Hotspot positions (x,y,z) — اضبط هذه الإحداثيات حسب حاجتك
    // For each source scene we list hotspot(s) that link to target scenes (as per user's mapping)
    const hotspotsData = {
      "Reception": [
        { id: 'h_rec_lr', position: {x: 0, y: 1.6, z: -3}, target: 'Living_Room', label: 'Living Room' }
      ],
      "Kitchen": [
        { id: 'h_kit_lr', position: {x: -1.5, y: 1.4, z: -2.2}, target: 'Living_Room', label: 'Living Room' }
      ],
      "Corridor": [
        { id: 'h_cor_lr', position: {x: 0, y: 1.5, z: -3.2}, target: 'Living_Room', label: 'Living Room' },
        { id: 'h_cor_bed', position: {x: 1.2, y: 1.4, z: -2.1}, target: 'Bedroom', label: 'Bedroom' },
        { id: 'h_cor_bath', position: {x: -1.1, y: 1.4, z: -2.1}, target: 'Bathroom', label: 'Bathroom' }
      ],
      "Living_Room": [
        { id: 'h_lr_rec', position: {x: 0, y: 1.6, z: -3}, target: 'Reception', label: 'Reception' },
        { id: 'h_lr_kit', position: {x: -1.8, y: 1.5, z: -2.3}, target: 'Kitchen', label: 'Kitchen' },
        { id: 'h_lr_cor', position: {x: 1.6, y: 1.5, z: -2.5}, target: 'Corridor', label: 'Corridor' }
      ],
      "Bedroom": [
        { id: 'h_bed_cor', position: {x: 0.6, y: 1.5, z: -2.1}, target: 'Corridor', label: 'Corridor' }
      ],
      "Bathroom": [
        { id: 'h_bath_cor', position: {x: -0.6, y: 1.5, z: -2.1}, target: 'Corridor', label: 'Corridor' }
      ]
    };

    // ---------- Helpers & Scene Setup ----------
    const sky = document.getElementById('sky');
    const hotspotsRoot = document.getElementById('hotspotsRoot');
    const fadePlane = document.getElementById('fadePlane');
    const welcome = document.getElementById('welcome');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const startBtn = document.getElementById('startBtn');

    let currentScene = 'Reception';
    let isTransitioning = false;

    // Preloader: track asset loads
    (function initPreloader(){
      const assets = document.querySelectorAll('#assets img');
      const total = assets.length;
      let loaded = 0;

      assets.forEach(img => {
        // if already complete
        if (img.complete && img.naturalWidth !== 0) {
          loaded++;
          updateProgress(loaded, total);
        } else {
          img.addEventListener('load', () => {
            loaded++;
            updateProgress(loaded, total);
          });
          img.addEventListener('error', () => {
            loaded++; updateProgress(loaded, total);
            console.warn('Failed to load asset', img.src);
          });
        }
      });

      function updateProgress(loaded, total) {
        const pct = Math.round((loaded / total) * 100);
        progressFill.style.width = pct + '%';
        progressText.textContent = `تحميل الأصول: ${pct}%`;
        if (loaded >= total) {
          progressFill.style.width = '100%';
          progressText.textContent = `جاهز! اضغط ابدأ للولوج إلى الجولة`;
          startBtn.disabled = false;
        }
      }

      startBtn.addEventListener('click', () => {
        welcome.style.display = 'none';
        document.getElementById('sceneInstructions').setAttribute('visible', true);
        // fade in from black
        fadeTo(0, 500);
        createHotspotsForScene(currentScene);
      });
    })();

    // Create hotspots for a given scene (clears previous)
    function createHotspotsForScene(sceneName) {
      // clear
      while (hotspotsRoot.firstChild) hotspotsRoot.removeChild(hotspotsRoot.firstChild);

      const list = hotspotsData[sceneName] || [];
      list.forEach(h => {
        const el = document.createElement('a-entity');
        el.setAttribute('class', 'clickable hotspot-entity');
        el.setAttribute('id', h.id);
        el.setAttribute('position', `${h.position.x} ${h.position.y} ${h.position.z}`);

        // the image icon (a-image)
        const img = document.createElement('a-image');
        img.setAttribute('src', '#hotspotIcon');
        img.setAttribute('width', '0.6');
        img.setAttribute('height', '0.6');
        img.setAttribute('look-at', '#camera'); // always face camera
        img.setAttribute('class', 'clickable');
        img.setAttribute('scale', '1 1 1');
        img.setAttribute('material', 'shader: flat; transparent: true;');

        // pulse animation (infinite)
        img.setAttribute('animation__pulse', 'property: scale; dir: alternate; dur: 900; easing: easeInOutSine; loop: true; to: 1.15 1.15 1.15');

        // label above hotspot (hidden by default)
        const label = document.createElement('a-entity');
        label.setAttribute('geometry', 'primitive: plane; height: 0.18; width: 0.9');
        label.setAttribute('material', 'color: #000; opacity: 0.6; shader: flat');
        label.setAttribute('position', '0 0.55 0');
        label.setAttribute('visible', 'false');

        const text = document.createElement('a-text');
        text.setAttribute('value', h.label);
        text.setAttribute('align', 'center');
        text.setAttribute('width', '1.6');
        text.setAttribute('position', '0 0 0.01');
        text.setAttribute('color', '#fff');
        text.setAttribute('wrap-count', '18');

        label.appendChild(text);

        // interaction behavior
        // show label and scale up on enter; revert on leave
        img.addEventListener('mouseenter', () => {
          label.setAttribute('visible', 'true');
          img.setAttribute('animation__hover', 'property: scale; to: 1.35 1.35 1.35; dur: 200; easing: easeOutQuad');
        });
        img.addEventListener('mouseleave', () => {
          label.setAttribute('visible', 'false');
          img.setAttribute('animation__hover', 'property: scale; to: 1 1 1; dur: 150; easing: easeOutQuad');
        });

        // click or gaze-based click: transition to target scene
        img.addEventListener('click', (ev) => {
          if (isTransitioning) return;
          goToScene(h.target);
        });

        // also support controller's raycast events
        el.appendChild(img);
        el.appendChild(label);
        hotspotsRoot.appendChild(el);
      });
    }

    // Smooth transition: fade to black, swap sky, fade back
    function goToScene(targetName) {
      if (!scenes[targetName]) {
        console.warn('Unknown target scene', targetName); return;
      }
      isTransitioning = true;
      fadeTo(1, 350).then(() => {
        // change sky src
        sky.setAttribute('src', scenes[targetName]);
        currentScene = targetName;
        // small delay to ensure texture updated
        setTimeout(() => {
          createHotspotsForScene(currentScene);
          fadeTo(0, 400).then(()=> { isTransitioning = false; });
        }, 200);
      });
    }

    // fade utility: animate fadePlane opacity
    function fadeTo(targetOpacity, duration=400) {
      return new Promise(resolve => {
        const plane = fadePlane;
        plane.setAttribute('animation__fade', `property: material.opacity; to: ${targetOpacity}; dur: ${duration}; easing: easeInOutQuad`);
        // wait duration
        setTimeout(resolve, duration + 20);
      });
    }

    // On scene load: set fade fully opaque then show welcome (handled by preloader)
    // Set initial fade to 1 (black) so welcome overlay shows; already in HTML set to opacity:1

    // Small helper: enable keyboard arrows to jump scenes (for desktop testing)
    window.addEventListener('keydown', (e) => {
      if (e.key === '1') goToScene('Reception');
      if (e.key === '2') goToScene('Living_Room');
      if (e.key === '3') goToScene('Kitchen');
      if (e.key === '4') goToScene('Corridor');
      if (e.key === '5') goToScene('Bedroom');
      if (e.key === '6') goToScene('Bathroom');
    });

    // Make sure components like look-at work (A-Frame built-in is fine). If label becomes mirrored on some devices adjust look-at.
    // End of script
  </script>

</body>
</html>
